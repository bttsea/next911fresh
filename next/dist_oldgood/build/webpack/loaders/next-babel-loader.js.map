{"version":3,"names":["_stringHash","_interopRequireDefault","require","_path","_babelLoader","e","__esModule","default","cacheKey","nextBabelPreset","getModernOptions","babelOptions","presetEnvOptions","Object","assign","transformRuntimeOptions","regenerator","targets","esmodules","exclude","nextBabelPresetModern","presetOptions","context","module","exports","babelLoader","custom","babel","presetItem","createConfigItem","type","applyCommonJs","commonJsItem","configs","Set","customOptions","opts","isServer","isModern","pagesDir","hasModern","filename","join","cwd","loader","cache","cacheCompression","cacheDirectory","distDir","cacheIdentifier","JSON","stringify","loadPartialConfig","sourceFileName","options","config","cfg","source","resourcePath","isPageFile","startsWith","hasFilesystemConfig","file","babelrc","has","add","console","log","presets","caller","plugins","pageConfigPlugin","push","indexOf","nextDataPlugin","key","basename","hash","nextPreset","find","preset","value","additionalPresets","filter","presetItemModern","resolve","overrides","test"],"sources":["next-babel-loader.js"],"sourcesContent":["import hash from 'string-hash'\nimport { join, basename } from 'path'\nimport babelLoader from 'babel-loader'\n\n// increment 'd' to invalidate cache\nconst cacheKey = 'babel-cache-' + 'd' + '-'\nconst nextBabelPreset = require('../../babel/preset')\n\nconst getModernOptions = (babelOptions = {}) => {\n  const presetEnvOptions = Object.assign({}, babelOptions['preset-env'])\n  const transformRuntimeOptions = Object.assign(\n    {},\n    babelOptions['transform-runtime'],\n    { regenerator: false }\n  )\n\n  presetEnvOptions.targets = {\n    esmodules: true\n  }\n  presetEnvOptions.exclude = [\n    ...(presetEnvOptions.exclude || []),\n    // Blacklist accidental inclusions\n    'transform-regenerator',\n    'transform-async-to-generator'\n  ]\n\n  return {\n    ...babelOptions,\n    'preset-env': presetEnvOptions,\n    'transform-runtime': transformRuntimeOptions\n  }\n}\n\nconst nextBabelPresetModern = presetOptions => context =>\n  nextBabelPreset(context, getModernOptions(presetOptions))\n\nmodule.exports = babelLoader.custom(babel => {\n  const presetItem = babel.createConfigItem(nextBabelPreset, {\n    type: 'preset'\n  })\n  const applyCommonJs = babel.createConfigItem(\n    require('../../babel/plugins/commonjs'),\n    { type: 'plugin' }\n  )\n  const commonJsItem = babel.createConfigItem(\n    require('@babel/plugin-transform-modules-commonjs'),\n    { type: 'plugin' }\n  )\n\n  const configs = new Set()\n\n  return {\n    customOptions (opts) {\n      const custom = {\n        isServer: opts.isServer,\n        isModern: opts.isModern,\n        pagesDir: opts.pagesDir,\n        hasModern: opts.hasModern\n      }\n      const filename = join(opts.cwd, 'noop.js')\n      const loader = Object.assign(\n        opts.cache\n          ? {\n            cacheCompression: false,\n            cacheDirectory: join(opts.distDir, 'cache', 'next-babel-loader'),\n            cacheIdentifier:\n                cacheKey +\n                (opts.isServer ? '-server' : '') +\n                (opts.isModern ? '-modern' : '') +\n                (opts.hasModern ? '-has-modern' : '') +\n                JSON.stringify(\n                  babel.loadPartialConfig({\n                    filename,\n                    cwd: opts.cwd,\n                    sourceFileName: filename\n                  }).options\n                )\n          }\n          : {\n            cacheDirectory: false\n          },\n        opts\n      )\n\n      delete loader.isServer\n      delete loader.cache\n      delete loader.distDir\n      delete loader.isModern\n      delete loader.hasModern\n      delete loader.pagesDir\n      return { loader, custom }\n    },\n    config (\n      cfg,\n      {\n        source,\n        customOptions: { isServer, isModern, hasModern, pagesDir }\n      }\n    ) {\n      const filename = this.resourcePath\n      const options = Object.assign({}, cfg.options)\n      const isPageFile = filename.startsWith(pagesDir)\n\n      if (cfg.hasFilesystemConfig()) {\n        for (const file of [cfg.babelrc, cfg.config]) {\n          // We only log for client compilation otherwise there will be double output\n          if (file && !isServer && !configs.has(file)) {\n            configs.add(file)\n            console.log(`> Using external babel configuration`)\n            console.log(`> Location: \"${file}\"`)\n          }\n        }\n      } else {\n        // Add our default preset if the no \"babelrc\" found.\n        options.presets = [...options.presets, presetItem]\n      }\n\n      options.caller.isServer = isServer\n      options.caller.isModern = isModern\n\n      options.plugins = options.plugins || []\n\n      if (!isServer && isPageFile) {\n        const pageConfigPlugin = babel.createConfigItem(\n          [require('../../babel/plugins/next-page-config')],\n          { type: 'plugin' }\n        )\n        options.plugins.push(pageConfigPlugin)\n      }\n\n      if (isServer && source.indexOf('next/data') !== -1) {\n        const nextDataPlugin = babel.createConfigItem(\n          [\n            require('../../babel/plugins/next-data'),\n            { key: basename(filename) + '-' + hash(filename) }\n          ],\n          { type: 'plugin' }\n        )\n        options.plugins.push(nextDataPlugin)\n      }\n\n      if (isModern) {\n        const nextPreset = options.presets.find(\n          preset => preset && preset.value === nextBabelPreset\n        ) || { options: {} }\n\n        const additionalPresets = options.presets.filter(\n          preset => preset !== nextPreset\n        )\n\n        const presetItemModern = babel.createConfigItem(\n          nextBabelPresetModern(nextPreset.options),\n          {\n            type: 'preset'\n          }\n        )\n\n        options.presets = [...additionalPresets, presetItemModern]\n      }\n\n      // If the file has `module.exports` we have to transpile commonjs because Babel adds `import` statements\n      // That break webpack, since webpack doesn't support combining commonjs and esmodules\n      if (!hasModern && source.indexOf('module.exports') !== -1) {\n        options.plugins.push(applyCommonJs)\n      }\n\n      options.plugins.push([\n        require.resolve('babel-plugin-transform-define'),\n        { 'typeof window': isServer ? 'undefined' : 'object' },\n        'next-js-transform-define-instance'\n      ])\n\n      // As next-server/lib has stateful modules we have to transpile commonjs\n      options.overrides = [\n        ...(options.overrides || []),\n        {\n          test: [\n            /next[\\\\/]dist[\\\\/]next-server[\\\\/]lib/,\n            /next[\\\\/]dist[\\\\/]client/,\n            /next[\\\\/]dist[\\\\/]pages/\n          ],\n          plugins: [commonJsItem]\n        }\n      ]\n\n      return options\n    }\n  }\n})\n"],"mappings":"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","ignoreList":[]}