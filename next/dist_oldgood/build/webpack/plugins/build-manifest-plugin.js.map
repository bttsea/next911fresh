{"version":3,"names":["_devalue","_interopRequireDefault","require","_constants","_webpackSources","e","__esModule","default","generateClientManifest","assetMap","isModern","clientManifest","appDependencies","Set","pages","Object","entries","forEach","page","dependencies","filteredDeps","filter","dep","has","test","length","devalue","BuildManifestPlugin","constructor","options","buildId","modern","apply","compiler","hooks","emit","tapAsync","compilation","callback","chunks","devFiles","mainJsChunk","find","c","name","CLIENT_STATIC_FILES_RUNTIME_MAIN","mainJsFiles","files","file","filePath","keys","assets","path","replace","push","entrypoint","entrypoints","result","ROUTE_NAME_REGEX","exec","pagePath","filesForEntry","chunk","IS_BUNDLED_PAGE_REGEX","CLIENT_STATIC_FILES_PATH","sort","reduce","a","BUILD_MANIFEST","RawSource","JSON","stringify","clientManifestPath","modernClientManifestPath","exports"],"sources":["build-manifest-plugin.ts"],"sourcesContent":["import devalue from 'devalue'\nimport {\n  BUILD_MANIFEST,\n  CLIENT_STATIC_FILES_PATH,\n  CLIENT_STATIC_FILES_RUNTIME_MAIN,\n  IS_BUNDLED_PAGE_REGEX,\n  ROUTE_NAME_REGEX,\n} from '../../../next-server/lib/constants'\nimport { Compiler } from 'webpack'\nimport { RawSource } from 'webpack-sources'\n\ninterface AssetMap {\n  devFiles: string[]\n  pages: {\n    '/_app': string[]\n    [s: string]: string[]\n  }\n}\n\n// This function takes the asset map generated in BuildManifestPlugin and creates a\n// reduced version to send to the client.\nconst generateClientManifest = (\n  assetMap: AssetMap,\n  isModern: boolean\n): string => {\n  const clientManifest: { [s: string]: string[] } = {}\n  const appDependencies = new Set(assetMap.pages['/_app'])\n\n  Object.entries(assetMap.pages).forEach(([page, dependencies]) => {\n    if (page === '/_app') return\n    // Filter out dependencies in the _app entry, because those will have already\n    // been loaded by the client prior to a navigation event\n    const filteredDeps = dependencies.filter(\n      dep => !appDependencies.has(dep) && /\\.module\\.js$/.test(dep) === isModern\n    )\n\n    // The manifest can omit the page if it has no requirements\n    if (filteredDeps.length) {\n      clientManifest[page] = filteredDeps\n    }\n  })\n  return devalue(clientManifest)\n}\n\n// This plugin creates a build-manifest.json for all assets that are being output\n// It has a mapping of \"entry\" filename to real filename. Because the real filename can be hashed in production\nexport default class BuildManifestPlugin {\n  private buildId: string\n  private clientManifest: boolean\n  private modern: boolean\n\n  constructor(options: {\n    buildId: string\n    clientManifest: boolean\n    modern: boolean\n  }) {\n    this.buildId = options.buildId\n    this.clientManifest = options.clientManifest\n    this.modern = options.modern\n  }\n\n  apply(compiler: Compiler) {\n    compiler.hooks.emit.tapAsync(\n      'NextJsBuildManifest',\n      (compilation, callback) => {\n        const { chunks } = compilation\n        const assetMap: AssetMap = { devFiles: [], pages: { '/_app': [] } }\n\n        const mainJsChunk = chunks.find(\n          c => c.name === CLIENT_STATIC_FILES_RUNTIME_MAIN\n        )\n        const mainJsFiles: string[] =\n          mainJsChunk && mainJsChunk.files.length > 0\n            ? mainJsChunk.files.filter((file: string) => /\\.js$/.test(file))\n            : []\n\n        for (const filePath of Object.keys(compilation.assets)) {\n          const path = filePath.replace(/\\\\/g, '/')\n          if (/^static\\/development\\/dll\\//.test(path)) {\n            assetMap.devFiles.push(path)\n          }\n        }\n\n        // compilation.entrypoints is a Map object, so iterating over it 0 is the key and 1 is the value\n        for (const [, entrypoint] of compilation.entrypoints.entries()) {\n          const result = ROUTE_NAME_REGEX.exec(entrypoint.name)\n          if (!result) {\n            continue\n          }\n\n          const pagePath = result[1]\n\n          if (!pagePath) {\n            continue\n          }\n\n          const filesForEntry: string[] = []\n          for (const chunk of entrypoint.chunks) {\n            // If there's no name or no files\n            if (!chunk.name || !chunk.files) {\n              continue\n            }\n\n            for (const file of chunk.files) {\n              if (/\\.map$/.test(file) || /\\.hot-update\\.js$/.test(file)) {\n                continue\n              }\n\n              // Only `.js` and `.css` files are added for now. In the future we can also handle other file types.\n              if (!/\\.js$/.test(file) && !/\\.css$/.test(file)) {\n                continue\n              }\n\n              // The page bundles are manually added to _document.js as they need extra properties\n              if (IS_BUNDLED_PAGE_REGEX.exec(file)) {\n                continue\n              }\n\n              filesForEntry.push(file.replace(/\\\\/g, '/'))\n            }\n          }\n\n          assetMap.pages[`/${pagePath.replace(/\\\\/g, '/')}`] = [\n            ...filesForEntry,\n            ...mainJsFiles,\n          ]\n        }\n\n        if (typeof assetMap.pages['/index'] !== 'undefined') {\n          assetMap.pages['/'] = assetMap.pages['/index']\n        }\n\n        // Add the runtime build manifest file (generated later in this file)\n        // as a dependency for the app. If the flag is false, the file won't be\n        // downloaded by the client.\n        if (this.clientManifest) {\n          assetMap.pages['/_app'].push(\n            `${CLIENT_STATIC_FILES_PATH}/${this.buildId}/_buildManifest.js`\n          )\n          if (this.modern) {\n            assetMap.pages['/_app'].push(\n              `${CLIENT_STATIC_FILES_PATH}/${\n                this.buildId\n              }/_buildManifest.module.js`\n            )\n          }\n        }\n\n        assetMap.pages = Object.keys(assetMap.pages)\n          .sort()\n          // eslint-disable-next-line\n          .reduce((a, c) => ((a[c] = assetMap.pages[c]), a), {} as any)\n\n        compilation.assets[BUILD_MANIFEST] = new RawSource(\n          JSON.stringify(assetMap, null, 2)\n        )\n\n        if (this.clientManifest) {\n          const clientManifestPath = `${CLIENT_STATIC_FILES_PATH}/${\n            this.buildId\n          }/_buildManifest.js`\n\n          compilation.assets[clientManifestPath] = new RawSource(\n            `self.__BUILD_MANIFEST = ${generateClientManifest(\n              assetMap,\n              false\n            )};` + `self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n          )\n\n          if (this.modern) {\n            const modernClientManifestPath = `${CLIENT_STATIC_FILES_PATH}/${\n              this.buildId\n            }/_buildManifest.module.js`\n\n            compilation.assets[modernClientManifestPath] = new RawSource(\n              `self.__BUILD_MANIFEST = ${generateClientManifest(\n                assetMap,\n                true\n              )};` + `self.__BUILD_MANIFEST_CB && self.__BUILD_MANIFEST_CB()`\n            )\n          }\n        }\n        callback()\n      }\n    )\n  }\n}\n"],"mappings":"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","ignoreList":[]}