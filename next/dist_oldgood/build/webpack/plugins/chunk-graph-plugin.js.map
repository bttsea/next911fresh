{"version":3,"names":["_constants","require","_path","_interopRequireDefault","_querystring","e","__esModule","default","manifest","sharedFiles","pages","pageChunks","chunks","pageModules","getPageChunks","page","external","Set","internal","map","mod","replace","match","includes","split","has","add","getFiles","dir","modules","length","getFileByIdentifier","id","startsWith","n","lastIndexOf","substring","path","isAbsolute","resolve","reduce","acc","val","concat","push","identifier","filter","Boolean","ChunkGraphPlugin","constructor","buildId","distDir","isServer","apply","compiler","hooks","emit","tap","compilation","sharedChunks","forEach","chunk","hasEntryModule","chunkModules","Map","queue","groupsIterable","chunksProcessed","involvedChunks","chunkGroup","files","file","m","modulesIterable","set","child","childrenIterable","values","nodeModules","isModule","relative","f","pageName","entryModule","loaders","entryLoader","find","loader","options","parse","name","CLIENT_STATIC_FILES_RUNTIME_MAIN","sort","getLambdaChunk","RegExp","exports"],"sources":["chunk-graph-plugin.ts"],"sourcesContent":["import { CLIENT_STATIC_FILES_RUNTIME_MAIN } from '../../../next-server/lib/constants'\nimport path from 'path'\nimport { parse } from 'querystring'\nimport { Compiler, Plugin } from 'webpack'\n\ntype StringDictionary = { [pageName: string]: string[] }\nconst manifest: {\n  sharedFiles: string[]\n  pages: StringDictionary\n  pageChunks: StringDictionary\n  chunks: StringDictionary\n} = {\n  sharedFiles: [],\n  pages: {},\n  pageChunks: {},\n  chunks: {},\n}\n\nconst pageModules: StringDictionary = {}\n\nexport function getPageChunks(\n  page: string\n):\n  | {\n      external: Set<String>\n      internal: Set<String>\n    }\n  | undefined {\n  if (!manifest.pages[page] && !pageModules[page]) {\n    return\n  }\n\n  const external = new Set<string>() // from node_modules\n  const internal = new Set<string>() // from project\n  ;[...(manifest.pages[page] || []), ...(pageModules[page] || [])].map(mod => {\n    mod = mod.replace(/\\\\/g, '/')\n\n    if (mod.match(/(next-server|next)\\//)) {\n      return null\n    }\n\n    if (mod.includes('node_modules/')) {\n      if (\n        mod.match(\n          /node_modules\\/(@babel|core-js|styled-jsx|string-hash|object-assign|process|react|react-dom|scheduler|regenerator-runtime|webpack|node-libs-browser)\\//\n        )\n      ) {\n        return null\n      }\n\n      mod = mod.split('node_modules/')[1].split('/')[0]\n      if (external.has(mod)) {\n        return null\n      }\n\n      external.add(mod)\n      return mod\n    }\n\n    // don't include the page itself\n    if (mod.includes(`pages${page === '/' ? '/index' : page}`)) {\n      return null\n    }\n\n    // is local e.g. ../components/Layout\n    if (internal.has(mod)) {\n      return null\n    }\n\n    internal.add(mod)\n    return mod\n  })\n\n  return {\n    external,\n    internal,\n  }\n}\n\nfunction getFiles(dir: string, modules: any[]): string[] {\n  if (!(modules && modules.length)) {\n    return []\n  }\n\n  function getFileByIdentifier(id: string) {\n    if (id.startsWith('external ') || id.startsWith('multi ')) {\n      return null\n    }\n\n    let n\n    if ((n = id.lastIndexOf('!')) !== -1) {\n      id = id.substring(n + 1)\n    }\n\n    if (id && !path.isAbsolute(id)) {\n      id = path.resolve(dir, id)\n    }\n\n    return id\n  }\n\n  return modules\n    .reduce(\n      (acc: any[], val: any) =>\n        val.modules\n          ? acc.concat(getFiles(dir, val.modules))\n          : (acc.push(\n              getFileByIdentifier(\n                typeof val.identifier === 'function'\n                  ? val.identifier()\n                  : val.identifier\n              )\n            ),\n            acc),\n      []\n    )\n    .filter(Boolean)\n}\n\nexport class ChunkGraphPlugin implements Plugin {\n  private buildId: string\n  private dir: string\n  private distDir: string\n  private isServer: boolean\n\n  constructor(\n    buildId: string,\n    {\n      dir,\n      distDir,\n      isServer,\n    }: {\n      dir: string\n      distDir: string\n      isServer: boolean\n    }\n  ) {\n    this.buildId = buildId\n    this.dir = dir\n    this.distDir = distDir\n    this.isServer = isServer\n  }\n\n  apply(compiler: Compiler) {\n    const { dir } = this\n    compiler.hooks.emit.tap('ChunkGraphPlugin', compilation => {\n      const sharedFiles = [] as string[]\n      const sharedChunks = [] as string[]\n      const pages: StringDictionary = {}\n      const pageChunks: StringDictionary = {}\n\n      compilation.chunks.forEach(chunk => {\n        if (!chunk.hasEntryModule()) {\n          return\n        }\n\n        const chunkModules = new Map<any, any>()\n\n        const queue = new Set<any>(chunk.groupsIterable)\n        const chunksProcessed = new Set<any>()\n\n        const involvedChunks = new Set<string>()\n\n        for (const chunkGroup of queue) {\n          for (const chunk of chunkGroup.chunks) {\n            chunk.files.forEach((file: string) => involvedChunks.add(file))\n            if (!chunksProcessed.has(chunk)) {\n              chunksProcessed.add(chunk)\n              for (const m of chunk.modulesIterable) {\n                chunkModules.set(m.id, m)\n              }\n            }\n          }\n          for (const child of chunkGroup.childrenIterable) {\n            queue.add(child)\n          }\n        }\n\n        const modules = [...chunkModules.values()]\n        const nodeModules: string[] = []\n        const files = getFiles(dir, modules)\n          // we don't care about node_modules (yet) because we invalidate the\n          // entirety of flying shuttle on package changes\n          .filter(val => {\n            // store them for build tree stats though\n            const isModule = val.includes('node_modules')\n            if (isModule) nodeModules.push(val)\n            return !isModule\n          })\n          // build artifacts shouldn't be considered, so we ensure all paths\n          // are outside of this directory\n          .filter(val => path.relative(this.distDir, val).startsWith('..'))\n          // convert from absolute path to be portable across operating systems\n          // and directories\n          .map(f => path.relative(dir, f))\n\n        let pageName: string | undefined\n        if (chunk.entryModule && chunk.entryModule.loaders) {\n          const entryLoader = chunk.entryModule.loaders.find(\n            ({\n              loader,\n              options,\n            }: {\n              loader?: string | null\n              options?: string | null\n            }) => loader && loader.match(/next-(\\w+-)+loader/) && options\n          )\n          if (entryLoader) {\n            const { page } = parse(entryLoader.options)\n            if (typeof page === 'string' && page) {\n              pageName = page\n            }\n          }\n        }\n\n        if (pageName) {\n          if (\n            pageName === '/_app' ||\n            pageName === '/_error' ||\n            pageName === '/_document'\n          ) {\n            sharedFiles.push(...files)\n            sharedChunks.push(...involvedChunks)\n          } else {\n            pages[pageName] = files\n            pageChunks[pageName] = [...involvedChunks]\n          }\n          pageModules[pageName] = nodeModules\n        } else {\n          if (chunk.name === CLIENT_STATIC_FILES_RUNTIME_MAIN) {\n            sharedFiles.push(...files)\n            sharedChunks.push(...involvedChunks)\n          } else {\n            manifest.chunks[chunk.name] = [\n              ...new Set([...(manifest.chunks[chunk.name] || []), ...files]),\n            ].sort()\n          }\n        }\n      })\n\n      const getLambdaChunk = (name: string) =>\n        name.includes(this.buildId)\n          ? name\n              .replace(new RegExp(`${this.buildId}[\\\\/\\\\\\\\]`), 'client/')\n              .replace(/[.]js$/, `.${this.buildId}.js`)\n          : name\n\n      manifest.sharedFiles = [\n        ...new Set([...(manifest.sharedFiles || []), ...sharedFiles]),\n      ].sort()\n\n      for (const page in pages) {\n        manifest.pages[page] = [\n          ...new Set([...(manifest.pages[page] || []), ...pages[page]]),\n        ].sort()\n\n        // There's no chunks to save from serverless bundles\n        if (!this.isServer) {\n          manifest.pageChunks[page] = [\n            ...new Set([\n              ...(manifest.pageChunks[page] || []),\n              ...pageChunks[page],\n              ...pageChunks[page].map(getLambdaChunk),\n              ...sharedChunks,\n              ...sharedChunks.map(getLambdaChunk),\n            ]),\n          ].sort()\n        }\n      }\n    })\n  }\n}\n"],"mappings":"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","ignoreList":[]}