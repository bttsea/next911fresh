{"version":3,"names":["SingleEntryPlugin","require","MultiEntryPlugin","JsonpTemplatePlugin","SplitChunksPlugin","RuntimeChunkPlugin","PLUGIN_NAME","NextEsmPlugin","constructor","options","Object","assign","excludedPlugins","additionalPlugins","apply","compiler","hooks","make","tapAsync","compilation","callback","runBuild","then","getBabelLoader","rules","rule","use","Array","isArray","find","r","loader","includes","ruleUse","ruleLoader","updateOptions","childCompiler","module","Error","babelLoader","isModern","updateAssets","childCompilation","assets","namedChunkGroups","childChunkFileMap","chunks","reduce","chunkMap","chunk","name","forEach","childChunk","files","push","filter","v","values","entrypoints","entryPoint","entryPointName","childEntryPoint","get","hasOwnProperty","outputOptions","output","filename","chunkFilename","plugins","c","concat","createChildCompiler","context","inputFileSystem","outputFileSystem","plugin","compilerEntries","entry","index","keys","entryFiles","optimization","splitChunks","runtimeChunk","additionalAssets","childProcessDone","runAsChild","err","entries","errors","length","exports","default"],"sources":["next-esm-plugin.ts"],"sourcesContent":["/**\n * MIT License\n *\n * Copyright (c) 2018 Prateek Bhatnagar\n *\n * Permission is hereby granted, free of charge, to any person obtaining a copy\n * of this software and associated documentation files (the \"Software\"), to deal\n * in the Software without restriction, including without limitation the rights\n * to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n * copies of the Software, and to permit persons to whom the Software is\n * furnished to do so, subject to the following conditions:\n *\n * The above copyright notice and this permission notice shall be included in all\n * copies or substantial portions of the Software.\n *\n * THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE\n * SOFTWARE.\n */\n\n/**\n * Webpack plugin for NextJs that runs a child compiler to generate a second (modern) JS bundle\n *\n * @author: Janicklas Ralph (https://github.com/janickals-ralph)\n *\n * Original source from which this was built upon - https://github.com/prateekbh/babel-esm-plugin\n */\nimport {\n  Compiler,\n  compilation,\n  Plugin,\n  RuleSetRule,\n  RuleSetLoader,\n  Output,\n} from 'webpack'\n\nconst SingleEntryPlugin = require('webpack/lib/SingleEntryPlugin')\nconst MultiEntryPlugin = require('webpack/lib/MultiEntryPlugin')\nconst JsonpTemplatePlugin = require('webpack/lib/web/JsonpTemplatePlugin')\nconst SplitChunksPlugin = require('webpack/lib/optimize/SplitChunksPlugin')\nconst RuntimeChunkPlugin = require('webpack/lib/optimize/RuntimeChunkPlugin')\n\nconst PLUGIN_NAME = 'NextEsmPlugin'\n\nexport default class NextEsmPlugin implements Plugin {\n  options: {\n    filename: any\n    chunkFilename: any\n    excludedPlugins: string[]\n    additionalPlugins: Plugin[]\n  }\n\n  constructor(options: {\n    filename: any\n    chunkFilename: any\n    excludedPlugins?: string[]\n    additionalPlugins?: any\n  }) {\n    this.options = Object.assign(\n      {\n        excludedPlugins: [PLUGIN_NAME],\n        additionalPlugins: [],\n      },\n      options\n    )\n  }\n\n  apply(compiler: Compiler) {\n    compiler.hooks.make.tapAsync(\n      PLUGIN_NAME,\n      (compilation: compilation.Compilation, callback) => {\n        this.runBuild(compiler, compilation).then(callback)\n      }\n    )\n  }\n\n  getBabelLoader(rules: RuleSetRule[]) {\n    for (let rule of rules) {\n      if (!rule.use) continue\n\n      if (Array.isArray(rule.use)) {\n        return (rule.use as RuleSetLoader[]).find(\n          r => r.loader && r.loader.includes('next-babel-loader')\n        )\n      }\n\n      const ruleUse = rule.use as RuleSetLoader\n      const ruleLoader = rule.loader as string\n      if (\n        (ruleUse.loader && ruleUse.loader.includes('next-babel-loader')) ||\n        (ruleLoader && ruleLoader.includes('next-babel-loader'))\n      ) {\n        return ruleUse || rule\n      }\n    }\n  }\n\n  updateOptions(childCompiler: Compiler) {\n    if (!childCompiler.options.module) {\n      throw new Error('Webpack.options.module not found!')\n    }\n\n    let babelLoader = this.getBabelLoader(childCompiler.options.module.rules)\n\n    if (!babelLoader) {\n      throw new Error('Babel-loader config not found!')\n    }\n\n    babelLoader.options = Object.assign({}, babelLoader.options, {\n      isModern: true,\n    })\n  }\n\n  updateAssets(\n    compilation: compilation.Compilation,\n    childCompilation: compilation.Compilation\n  ) {\n    compilation.assets = Object.assign(\n      childCompilation.assets,\n      compilation.assets\n    )\n\n    compilation.namedChunkGroups = Object.assign(\n      childCompilation.namedChunkGroups,\n      compilation.namedChunkGroups\n    )\n\n    const childChunkFileMap = childCompilation.chunks.reduce(\n      (\n        chunkMap: { [key: string]: compilation.Chunk },\n        chunk: compilation.Chunk\n      ) => {\n        chunkMap[chunk.name] = chunk\n        return chunkMap\n      },\n      {}\n    )\n\n    // Merge files from similar chunks\n    compilation.chunks.forEach((chunk: compilation.Chunk) => {\n      const childChunk = childChunkFileMap[chunk.name]\n\n      if (childChunk && childChunk.files) {\n        delete childChunkFileMap[chunk.name]\n        chunk.files.push(\n          ...childChunk.files.filter((v: any) => !chunk.files.includes(v))\n        )\n      }\n    })\n\n    // Add modern only chunks\n    compilation.chunks.push(...Object.values(childChunkFileMap))\n\n    // Place modern only chunk inside the right entry point\n    compilation.entrypoints.forEach((entryPoint, entryPointName) => {\n      const childEntryPoint = childCompilation.entrypoints.get(entryPointName)\n\n      childEntryPoint.chunks.forEach((chunk: compilation.Chunk) => {\n        if (childChunkFileMap.hasOwnProperty(chunk.name)) {\n          entryPoint.chunks.push(chunk)\n        }\n      })\n    })\n  }\n\n  async runBuild(compiler: Compiler, compilation: compilation.Compilation) {\n    const outputOptions: Output = { ...compiler.options.output }\n\n    if (typeof this.options.filename === 'function') {\n      outputOptions.filename = this.options.filename(outputOptions.filename)\n    } else {\n      outputOptions.filename = this.options.filename\n    }\n\n    if (typeof this.options.chunkFilename === 'function') {\n      outputOptions.chunkFilename = this.options.chunkFilename(\n        outputOptions.chunkFilename\n      )\n    } else {\n      outputOptions.chunkFilename = this.options.chunkFilename\n    }\n\n    let plugins = (compiler.options.plugins || []).filter(\n      c => !this.options.excludedPlugins.includes(c.constructor.name)\n    )\n\n    // Add the additionalPlugins\n    plugins = plugins.concat(this.options.additionalPlugins)\n\n    /**\n     * We are deliberatly not passing plugins in createChildCompiler.\n     * All webpack does with plugins is to call `apply` method on them\n     * with the childCompiler.\n     * But by then we haven't given childCompiler a fileSystem or other options\n     * which a few plugins might expect while execution the apply method.\n     * We do call the `apply` method of all plugins by ourselves later in the code\n     */\n    const childCompiler = compilation.createChildCompiler(\n      PLUGIN_NAME,\n      outputOptions\n    )\n\n    childCompiler.context = compiler.context\n    childCompiler.inputFileSystem = compiler.inputFileSystem\n    childCompiler.outputFileSystem = compiler.outputFileSystem\n\n    // Call the `apply` method of all plugins by ourselves.\n    if (Array.isArray(plugins)) {\n      for (const plugin of plugins) {\n        plugin.apply(childCompiler)\n      }\n    }\n\n    let compilerEntries: any = compiler.options.entry\n    if (typeof compilerEntries === 'function') {\n      compilerEntries = await compilerEntries()\n    }\n    if (typeof compilerEntries === 'string') {\n      compilerEntries = { index: compilerEntries }\n    }\n\n    Object.keys(compilerEntries).forEach(entry => {\n      const entryFiles = compilerEntries[entry]\n      if (Array.isArray(entryFiles)) {\n        new MultiEntryPlugin(compiler.context, entryFiles, entry).apply(\n          childCompiler\n        )\n      } else {\n        new SingleEntryPlugin(compiler.context, entryFiles, entry).apply(\n          childCompiler\n        )\n      }\n    })\n\n    // Convert entry chunk to entry file\n    new JsonpTemplatePlugin().apply(childCompiler)\n\n    const optimization = compiler.options.optimization\n    if (optimization) {\n      if (optimization.splitChunks) {\n        new SplitChunksPlugin(\n          Object.assign({}, optimization.splitChunks)\n        ).apply(childCompiler)\n      }\n\n      if (optimization.runtimeChunk) {\n        new RuntimeChunkPlugin(\n          Object.assign({}, optimization.runtimeChunk)\n        ).apply(childCompiler)\n      }\n    }\n\n    compilation.hooks.additionalAssets.tapAsync(\n      PLUGIN_NAME,\n      childProcessDone => {\n        this.updateOptions(childCompiler)\n\n        childCompiler.runAsChild((err, entries, childCompilation) => {\n          if (err) {\n            return childProcessDone(err)\n          }\n\n          if (childCompilation.errors.length > 0) {\n            return childProcessDone(childCompilation.errors[0])\n          }\n\n          this.updateAssets(compilation, childCompilation)\n          childProcessDone()\n        })\n      }\n    )\n  }\n}\n"],"mappings":"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","ignoreList":[]}