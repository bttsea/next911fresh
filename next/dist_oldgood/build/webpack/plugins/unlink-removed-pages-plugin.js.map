{"version":3,"names":["_path","require","_util","_fs","_interopRequireDefault","_constants","e","__esModule","default","unlink","promisify","fs","UnlinkRemovedPagesPlugin","constructor","prevAssets","apply","compiler","hooks","afterEmit","tapAsync","compilation","callback","removed","Object","keys","filter","a","IS_BUNDLED_PAGE_REGEX","test","assets","Promise","all","map","f","path","join","outputPath","err","code","then","exports"],"sources":["unlink-removed-pages-plugin.ts"],"sourcesContent":["import { join } from 'path'\nimport { promisify } from 'util'\nimport fs from 'fs'\nimport { IS_BUNDLED_PAGE_REGEX } from '../../../next-server/lib/constants'\nimport { Compiler } from 'webpack'\n\nconst unlink = promisify(fs.unlink)\n\n// Makes sure removed pages are removed from `.next` in development\nexport class UnlinkRemovedPagesPlugin {\n  prevAssets: any\n  constructor() {\n    this.prevAssets = {}\n  }\n\n  apply(compiler: Compiler) {\n    compiler.hooks.afterEmit.tapAsync(\n      'NextJsUnlinkRemovedPages',\n      (compilation, callback) => {\n        const removed = Object.keys(this.prevAssets).filter(\n          a => IS_BUNDLED_PAGE_REGEX.test(a) && !compilation.assets[a]\n        )\n\n        this.prevAssets = compilation.assets\n\n        Promise.all(\n          removed.map(async f => {\n            const path = join((compiler as any).outputPath, f)\n            try {\n              await unlink(path)\n            } catch (err) {\n              if (err.code === 'ENOENT') return\n              throw err\n            }\n          })\n        ).then(() => callback(), callback)\n      }\n    )\n  }\n}\n"],"mappings":"6EAAA,IAAAA,KAAA,CAAAC,OAAA,SACA,IAAAC,KAAA,CAAAD,OAAA,SACA,IAAAE,GAAA,CAAAC,sBAAA,CAAAH,OAAA,QACA,IAAAI,UAAA,CAAAJ,OAAA,uCAA0E,SAAAG,uBAAAE,CAAA,SAAAA,CAAA,EAAAA,CAAA,CAAAC,UAAA,CAAAD,CAAA,EAAAE,OAAA,CAAAF,CAAA,GAG1E,KAAM,CAAAG,MAAM,CAAG,GAAAC,eAAS,EAACC,WAAE,CAACF,MAAM,CAAC,CAEnC;AACO,KAAM,CAAAG,wBAAyB,CAEpCC,WAAWA,CAAA,CAAG,MADdC,UAAU,QAER,IAAI,CAACA,UAAU,CAAG,CAAC,CAAC,CACtB,CAEAC,KAAKA,CAACC,QAAkB,CAAE,CACxBA,QAAQ,CAACC,KAAK,CAACC,SAAS,CAACC,QAAQ,CAC/B,0BAA0B,CAC1B,CAACC,WAAW,CAAEC,QAAQ,GAAK,CACzB,KAAM,CAAAC,OAAO,CAAGC,MAAM,CAACC,IAAI,CAAC,IAAI,CAACV,UAAU,CAAC,CAACW,MAAM,CACjDC,CAAC,EAAIC,gCAAqB,CAACC,IAAI,CAACF,CAAC,CAAC,EAAI,CAACN,WAAW,CAACS,MAAM,CAACH,CAAC,CAC7D,CAAC,CAED,IAAI,CAACZ,UAAU,CAAGM,WAAW,CAACS,MAAM,CAEpCC,OAAO,CAACC,GAAG,CACTT,OAAO,CAACU,GAAG,CAAC,KAAM,CAAAC,CAAC,EAAI,CACrB,KAAM,CAAAC,IAAI,CAAG,GAAAC,UAAI,EAAEnB,QAAQ,CAASoB,UAAU,CAAEH,CAAC,CAAC,CAClD,GAAI,CACF,KAAM,CAAAxB,MAAM,CAACyB,IAAI,CAAC,CACpB,CAAE,MAAOG,GAAG,CAAE,CACZ,GAAIA,GAAG,CAACC,IAAI,GAAK,QAAQ,CAAE,OAC3B,KAAM,CAAAD,GAAG,CACX,CACF,CAAC,CACH,CAAC,CAACE,IAAI,CAAC,IAAMlB,QAAQ,CAAC,CAAC,CAAEA,QAAQ,CAAC,CACpC,CACF,CAAC,CACH,CACF,CAACmB,OAAA,CAAA5B,wBAAA,CAAAA,wBAAA","ignoreList":[]}