{"version":3,"names":["_webpack","_interopRequireDefault","require","_webpackSources","_path","_constants","e","__esModule","default","SSR_MODULE_CACHE_FILENAME","NextJsSsrImportPlugin","constructor","options","apply","compiler","outputPath","hooks","emit","tapAsync","compilation","callback","assets","RawSource","tap","mainTemplate","localVars","intercept","register","tapInfo","name","originalFn","fn","source","chunk","IS_BUNDLED_PAGE_REGEX","exec","pagePath","join","dirname","relativePathToBaseDir","relative","relativePathToBaseDirNormalized","replace","webpack","Template","asString","exports"],"sources":["nextjs-ssr-module-cache.ts"],"sourcesContent":["import webpack from 'webpack'\nimport { RawSource } from 'webpack-sources'\nimport { join, relative, dirname } from 'path'\nimport { IS_BUNDLED_PAGE_REGEX } from '../../../next-server/lib/constants'\n\nconst SSR_MODULE_CACHE_FILENAME = 'ssr-module-cache.js'\n\n// By default webpack keeps initialized modules per-module.\n// This means that if you have 2 entrypoints loaded into the same app\n// they will *not* share the same instance\n// This creates many issues when developers / libraries rely on the singleton pattern\n// As this pattern assumes every module will have 1 instance\n// This plugin overrides webpack's code generation step to replace `installedModules`\n// The replacement is a require for a file that's also generated here that only exports an empty object\n// Because of Node.js's single instance modules this makes webpack share all initialized instances\n// Do note that this module is only geared towards the `node` compilation target.\n// For the client side compilation we use `runtimeChunk: 'single'`\nexport default class NextJsSsrImportPlugin {\n  private options: { outputPath: string }\n\n  constructor(options: { outputPath: string }) {\n    this.options = options\n  }\n  apply(compiler: webpack.Compiler) {\n    const { outputPath } = this.options\n    compiler.hooks.emit.tapAsync(\n      'NextJsSSRModuleCache',\n      (compilation, callback) => {\n        compilation.assets[SSR_MODULE_CACHE_FILENAME] = new RawSource(`\n      /* This cache is used by webpack for instantiated modules */\n      module.exports = {}\n      `)\n        callback()\n      }\n    )\n    compiler.hooks.compilation.tap(\n      'NextJsSSRModuleCache',\n      (compilation: any) => {\n        compilation.mainTemplate.hooks.localVars.intercept({\n          register(tapInfo: any) {\n            if (tapInfo.name === 'MainTemplate') {\n              const originalFn = tapInfo.fn\n              tapInfo.fn = (source: any, chunk: any) => {\n                // If the chunk is not part of the pages directory we have to keep the original behavior,\n                // otherwise webpack will error out when the file is used before the compilation finishes\n                // this is the case with mini-css-extract-plugin\n                if (!IS_BUNDLED_PAGE_REGEX.exec(chunk.name)) {\n                  return originalFn(source, chunk)\n                }\n                const pagePath = join(outputPath, dirname(chunk.name))\n                let relativePathToBaseDir = relative(\n                  pagePath,\n                  join(outputPath, SSR_MODULE_CACHE_FILENAME)\n                )\n\n                // Make sure even in windows, the path looks like in unix\n                // Node.js require system will convert it accordingly\n                const relativePathToBaseDirNormalized = relativePathToBaseDir.replace(\n                  /\\\\/g,\n                  '/'\n                )\n                return (webpack as any).Template.asString([\n                  source,\n                  '// The module cache',\n                  `var installedModules = require('${relativePathToBaseDirNormalized}');`,\n                ])\n              }\n            }\n            return tapInfo\n          },\n        })\n      }\n    )\n  }\n}\n"],"mappings":"4DAAA,IAAAA,QAAA,CAAAC,sBAAA,CAAAC,OAAA,aACA,IAAAC,eAAA,CAAAD,OAAA,oBACA,IAAAE,KAAA,CAAAF,OAAA,SACA,IAAAG,UAAA,CAAAH,OAAA,uCAA0E,SAAAD,uBAAAK,CAAA,SAAAA,CAAA,EAAAA,CAAA,CAAAC,UAAA,CAAAD,CAAA,EAAAE,OAAA,CAAAF,CAAA,GAE1E,KAAM,CAAAG,yBAAyB,CAAG,qBAAqB,CAEvD;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACe,KAAM,CAAAC,qBAAsB,CAGzCC,WAAWA,CAACC,OAA+B,CAAE,MAFrCA,OAAO,QAGb,IAAI,CAACA,OAAO,CAAGA,OAAO,CACxB,CACAC,KAAKA,CAACC,QAA0B,CAAE,CAChC,KAAM,CAAEC,UAAW,CAAC,CAAG,IAAI,CAACH,OAAO,CACnCE,QAAQ,CAACE,KAAK,CAACC,IAAI,CAACC,QAAQ,CAC1B,sBAAsB,CACtB,CAACC,WAAW,CAAEC,QAAQ,GAAK,CACzBD,WAAW,CAACE,MAAM,CAACZ,yBAAyB,CAAC,CAAG,GAAI,CAAAa,yBAAS,CAAC;AACtE;AACA;AACA,OAAO,CAAC,CACAF,QAAQ,CAAC,CAAC,CACZ,CACF,CAAC,CACDN,QAAQ,CAACE,KAAK,CAACG,WAAW,CAACI,GAAG,CAC5B,sBAAsB,CACrBJ,WAAgB,EAAK,CACpBA,WAAW,CAACK,YAAY,CAACR,KAAK,CAACS,SAAS,CAACC,SAAS,CAAC,CACjDC,QAAQA,CAACC,OAAY,CAAE,CACrB,GAAIA,OAAO,CAACC,IAAI,GAAK,cAAc,CAAE,CACnC,KAAM,CAAAC,UAAU,CAAGF,OAAO,CAACG,EAAE,CAC7BH,OAAO,CAACG,EAAE,CAAG,CAACC,MAAW,CAAEC,KAAU,GAAK,CACxC;AACA;AACA;AACA,GAAI,CAACC,gCAAqB,CAACC,IAAI,CAACF,KAAK,CAACJ,IAAI,CAAC,CAAE,CAC3C,MAAO,CAAAC,UAAU,CAACE,MAAM,CAAEC,KAAK,CAAC,CAClC,CACA,KAAM,CAAAG,QAAQ,CAAG,GAAAC,UAAI,EAACtB,UAAU,CAAE,GAAAuB,aAAO,EAACL,KAAK,CAACJ,IAAI,CAAC,CAAC,CACtD,GAAI,CAAAU,qBAAqB,CAAG,GAAAC,cAAQ,EAClCJ,QAAQ,CACR,GAAAC,UAAI,EAACtB,UAAU,CAAEN,yBAAyB,CAC5C,CAAC,CAED;AACA;AACA,KAAM,CAAAgC,+BAA+B,CAAGF,qBAAqB,CAACG,OAAO,CACnE,KAAK,CACL,GACF,CAAC,CACD,MAAQ,CAAAC,gBAAO,CAASC,QAAQ,CAACC,QAAQ,CAAC,CACxCb,MAAM,CACN,qBAAqB,CACrB,mCAAmCS,+BAA+B,KAAK,CACxE,CAAC,CACJ,CAAC,CACH,CACA,MAAO,CAAAb,OAAO,CAChB,CACF,CAAC,CAAC,CACJ,CACF,CAAC,CACH,CACF,CAACkB,OAAA,CAAAtC,OAAA,CAAAE,qBAAA","ignoreList":[]}