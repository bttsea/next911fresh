{"version":3,"names":["_path","require","_minify","_interopRequireDefault","_util","_jestWorker","_fs","_mkdirp","e","__esModule","default","worker","resolve","writeFileP","promisify","writeFile","readFileP","readFile","TaskRunner","constructor","distDir","cpus","cache","mkdirp","sync","cacheDir","join","maxConcurrentWorkers","run","tasks","callback","length","workers","Worker","enableWorkerThreads","numWorkers","boundWorkers","options","minify","toRun","results","step","index","data","forEach","task","cachePath","cacheKey","enqueue","result","done","JSON","stringify","then","catch","error","parse","exit","end","exports"],"sources":["TaskRunner.js"],"sourcesContent":["import { join } from 'path'\nimport minify from './minify'\nimport { promisify } from 'util'\nimport Worker from 'jest-worker'\nimport { writeFile, readFile } from 'fs'\nimport mkdirp from 'mkdirp'\n\nconst worker = require.resolve('./minify')\nconst writeFileP = promisify(writeFile)\nconst readFileP = promisify(readFile)\n\nexport default class TaskRunner {\n  constructor({ distDir, cpus, cache }) {\n    if (cache) {\n      mkdirp.sync((this.cacheDir = join(distDir, 'cache', 'next-minifier')))\n    }\n    // In some cases cpus() returns undefined\n    // https://github.com/nodejs/node/issues/19022\n    this.maxConcurrentWorkers = cpus\n  }\n\n  run(tasks, callback) {\n    /* istanbul ignore if */\n    if (!tasks.length) {\n      callback(null, [])\n      return\n    }\n\n    if (this.maxConcurrentWorkers > 1) {\n      this.workers = new Worker(worker, {\n        enableWorkerThreads: true,\n        numWorkers: this.maxConcurrentWorkers,\n      })\n      this.boundWorkers = options => this.workers.default(options)\n    } else {\n      this.boundWorkers = async options => minify(options)\n    }\n\n    let toRun = tasks.length\n    const results = []\n    const step = (index, data) => {\n      toRun -= 1\n      results[index] = data\n\n      if (!toRun) {\n        callback(null, results)\n      }\n    }\n\n    tasks.forEach((task, index) => {\n      const cachePath = this.cacheDir && join(this.cacheDir, task.cacheKey)\n      const enqueue = async () => {\n        try {\n          const result = await this.boundWorkers(task)\n          const done = () => step(index, result)\n          if (cachePath) {\n            writeFileP(cachePath, JSON.stringify(result), 'utf8')\n              .then(done)\n              .catch(done)\n          }\n        } catch (error) {\n          step(index, { error })\n        }\n      }\n\n      if (this.cacheDir) {\n        readFileP(cachePath, 'utf8')\n          .then(data => step(index, JSON.parse(data)))\n          .catch(() => enqueue())\n      } else {\n        enqueue()\n      }\n    })\n  }\n\n  exit() {\n    if (this.workers) {\n      this.workers.end()\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}