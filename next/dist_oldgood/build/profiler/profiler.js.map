{"version":3,"names":["_path","_interopRequireDefault","require","_mkdirp","_fs","e","__esModule","default","inspector","console","log","Profiler","constructor","session","undefined","hasSession","startProfiling","Promise","resolve","Session","connect","_","all","sendCommand","interval","method","params","reject","post","err","destroy","disconnect","stopProfiling","Tracer","createTrace","outputPath","trace","noStream","profiler","test","dirPath","path","dirname","mkdirp","sync","fsStream","fs","createWriteStream","counter","pipe","instantEvent","name","id","cat","args","data","sessionId","page","frames","frame","url","end","callback","on","push","exports"],"sources":["profiler.js"],"sourcesContent":["import path from 'path'\nimport mkdirp from 'mkdirp'\nimport fs from 'fs'\n\nlet inspector\ntry {\n  // eslint-disable-next-line node/no-unsupported-features/node-builtins\n  inspector = require('inspector')\n} catch (e) {\n  console.log('Unable to CPU profile in < node 8.0')\n}\n\nclass Profiler {\n  constructor (inspector) {\n    this.session = undefined\n    this.inspector = inspector\n  }\n\n  hasSession () {\n    return this.session !== undefined\n  }\n\n  startProfiling () {\n    if (this.inspector === undefined) {\n      return Promise.resolve()\n    }\n\n    try {\n      this.session = new inspector.Session()\n      this.session.connect()\n    } catch (_) {\n      this.session = undefined\n      return Promise.resolve()\n    }\n\n    return Promise.all([\n      this.sendCommand('Profiler.setSamplingInterval', {\n        interval: 100\n      }),\n      this.sendCommand('Profiler.enable'),\n      this.sendCommand('Profiler.start')\n    ])\n  }\n\n  sendCommand (method, params) {\n    if (this.hasSession()) {\n      return new Promise((resolve, reject) => {\n        return this.session.post(method, params, (err, params) => {\n          if (err !== null) {\n            reject(err)\n          } else {\n            resolve(params)\n          }\n        })\n      })\n    } else {\n      return Promise.resolve()\n    }\n  }\n\n  destroy () {\n    if (this.hasSession()) {\n      this.session.disconnect()\n    }\n\n    return Promise.resolve()\n  }\n\n  stopProfiling () {\n    return this.sendCommand('Profiler.stop')\n  }\n}\n\nconst { Tracer } = require('chrome-trace-event')\n\n/**\n * an object that wraps Tracer and Profiler with a counter\n * @typedef {Object} Trace\n * @property {Tracer} trace instance of Tracer\n * @property {number} counter Counter\n * @property {Profiler} profiler instance of Profiler\n * @property {Function} end the end function\n */\n\n/**\n * @param {string} outputPath The location where to write the log.\n * @returns {Trace} The trace object\n */\nexport const createTrace = outputPath => {\n  const trace = new Tracer({\n    noStream: true\n  })\n  const profiler = new Profiler(inspector)\n  if (/\\/|\\\\/.test(outputPath)) {\n    const dirPath = path.dirname(outputPath)\n    mkdirp.sync(dirPath)\n  }\n  const fsStream = fs.createWriteStream(outputPath)\n\n  let counter = 0\n\n  trace.pipe(fsStream)\n  // These are critical events that need to be inserted so that tools like\n  // chrome dev tools can load the profile.\n  trace.instantEvent({\n    name: 'TracingStartedInPage',\n    id: ++counter,\n    cat: ['disabled-by-default-devtools.timeline'],\n    args: {\n      data: {\n        sessionId: '-1',\n        page: '0xfff',\n        frames: [\n          {\n            frame: '0xfff',\n            url: 'webpack',\n            name: ''\n          }\n        ]\n      }\n    }\n  })\n\n  trace.instantEvent({\n    name: 'TracingStartedInBrowser',\n    id: ++counter,\n    cat: ['disabled-by-default-devtools.timeline'],\n    args: {\n      data: {\n        sessionId: '-1'\n      }\n    }\n  })\n\n  return {\n    trace,\n    counter,\n    profiler,\n    end: callback => {\n      // Wait until the write stream finishes.\n      fsStream.on('finish', () => {\n        callback()\n      })\n      // Tear down the readable trace stream.\n      trace.push(null)\n    }\n  }\n}\n"],"mappings":"gEAAA,IAAAA,KAAA,CAAAC,sBAAA,CAAAC,OAAA,UACA,IAAAC,OAAA,CAAAF,sBAAA,CAAAC,OAAA,YACA,IAAAE,GAAA,CAAAH,sBAAA,CAAAC,OAAA,QAAmB,SAAAD,uBAAAI,CAAA,SAAAA,CAAA,EAAAA,CAAA,CAAAC,UAAA,CAAAD,CAAA,EAAAE,OAAA,CAAAF,CAAA,GAEnB,GAAI,CAAAG,SAAS,CACb,GAAI,CACF;AACAA,SAAS,CAAGN,OAAO,CAAC,WAAW,CAAC,CAClC,CAAE,MAAOG,CAAC,CAAE,CACVI,OAAO,CAACC,GAAG,CAAC,qCAAqC,CAAC,CACpD,CAEA,KAAM,CAAAC,QAAS,CACbC,WAAWA,CAAEJ,SAAS,CAAE,CACtB,IAAI,CAACK,OAAO,CAAGC,SAAS,CACxB,IAAI,CAACN,SAAS,CAAGA,SAAS,CAC5B,CAEAO,UAAUA,CAAA,CAAI,CACZ,MAAO,KAAI,CAACF,OAAO,GAAKC,SAAS,CACnC,CAEAE,cAAcA,CAAA,CAAI,CAChB,GAAI,IAAI,CAACR,SAAS,GAAKM,SAAS,CAAE,CAChC,MAAO,CAAAG,OAAO,CAACC,OAAO,CAAC,CAAC,CAC1B,CAEA,GAAI,CACF,IAAI,CAACL,OAAO,CAAG,GAAI,CAAAL,SAAS,CAACW,OAAO,CAAC,CAAC,CACtC,IAAI,CAACN,OAAO,CAACO,OAAO,CAAC,CAAC,CACxB,CAAE,MAAOC,CAAC,CAAE,CACV,IAAI,CAACR,OAAO,CAAGC,SAAS,CACxB,MAAO,CAAAG,OAAO,CAACC,OAAO,CAAC,CAAC,CAC1B,CAEA,MAAO,CAAAD,OAAO,CAACK,GAAG,CAAC,CACjB,IAAI,CAACC,WAAW,CAAC,8BAA8B,CAAE,CAC/CC,QAAQ,CAAE,GACZ,CAAC,CAAC,CACF,IAAI,CAACD,WAAW,CAAC,iBAAiB,CAAC,CACnC,IAAI,CAACA,WAAW,CAAC,gBAAgB,CAAC,CACnC,CAAC,CACJ,CAEAA,WAAWA,CAAEE,MAAM,CAAEC,MAAM,CAAE,CAC3B,GAAI,IAAI,CAACX,UAAU,CAAC,CAAC,CAAE,CACrB,MAAO,IAAI,CAAAE,OAAO,CAAC,CAACC,OAAO,CAAES,MAAM,GAAK,CACtC,MAAO,KAAI,CAACd,OAAO,CAACe,IAAI,CAACH,MAAM,CAAEC,MAAM,CAAE,CAACG,GAAG,CAAEH,MAAM,GAAK,CACxD,GAAIG,GAAG,GAAK,IAAI,CAAE,CAChBF,MAAM,CAACE,GAAG,CAAC,CACb,CAAC,IAAM,CACLX,OAAO,CAACQ,MAAM,CAAC,CACjB,CACF,CAAC,CAAC,CACJ,CAAC,CAAC,CACJ,CAAC,IAAM,CACL,MAAO,CAAAT,OAAO,CAACC,OAAO,CAAC,CAAC,CAC1B,CACF,CAEAY,OAAOA,CAAA,CAAI,CACT,GAAI,IAAI,CAACf,UAAU,CAAC,CAAC,CAAE,CACrB,IAAI,CAACF,OAAO,CAACkB,UAAU,CAAC,CAAC,CAC3B,CAEA,MAAO,CAAAd,OAAO,CAACC,OAAO,CAAC,CAAC,CAC1B,CAEAc,aAAaA,CAAA,CAAI,CACf,MAAO,KAAI,CAACT,WAAW,CAAC,eAAe,CAAC,CAC1C,CACF,CAEA,KAAM,CAAEU,MAAO,CAAC,CAAG/B,OAAO,CAAC,oBAAoB,CAAC,CAEhD;AACA;AACA;AACA;AACA;AACA;AACA;AACA,GAEA;AACA;AACA;AACA,GACO,KAAM,CAAAgC,WAAW,CAAGC,UAAU,EAAI,CACvC,KAAM,CAAAC,KAAK,CAAG,GAAI,CAAAH,MAAM,CAAC,CACvBI,QAAQ,CAAE,IACZ,CAAC,CAAC,CACF,KAAM,CAAAC,QAAQ,CAAG,GAAI,CAAA3B,QAAQ,CAACH,SAAS,CAAC,CACxC,GAAI,OAAO,CAAC+B,IAAI,CAACJ,UAAU,CAAC,CAAE,CAC5B,KAAM,CAAAK,OAAO,CAAGC,aAAI,CAACC,OAAO,CAACP,UAAU,CAAC,CACxCQ,eAAM,CAACC,IAAI,CAACJ,OAAO,CAAC,CACtB,CACA,KAAM,CAAAK,QAAQ,CAAGC,WAAE,CAACC,iBAAiB,CAACZ,UAAU,CAAC,CAEjD,GAAI,CAAAa,OAAO,CAAG,CAAC,CAEfZ,KAAK,CAACa,IAAI,CAACJ,QAAQ,CAAC,CACpB;AACA;AACAT,KAAK,CAACc,YAAY,CAAC,CACjBC,IAAI,CAAE,sBAAsB,CAC5BC,EAAE,CAAE,EAAEJ,OAAO,CACbK,GAAG,CAAE,CAAC,uCAAuC,CAAC,CAC9CC,IAAI,CAAE,CACJC,IAAI,CAAE,CACJC,SAAS,CAAE,IAAI,CACfC,IAAI,CAAE,OAAO,CACbC,MAAM,CAAE,CACN,CACEC,KAAK,CAAE,OAAO,CACdC,GAAG,CAAE,SAAS,CACdT,IAAI,CAAE,EACR,CAAC,CAEL,CACF,CACF,CAAC,CAAC,CAEFf,KAAK,CAACc,YAAY,CAAC,CACjBC,IAAI,CAAE,yBAAyB,CAC/BC,EAAE,CAAE,EAAEJ,OAAO,CACbK,GAAG,CAAE,CAAC,uCAAuC,CAAC,CAC9CC,IAAI,CAAE,CACJC,IAAI,CAAE,CACJC,SAAS,CAAE,IACb,CACF,CACF,CAAC,CAAC,CAEF,MAAO,CACLpB,KAAK,CACLY,OAAO,CACPV,QAAQ,CACRuB,GAAG,CAAEC,QAAQ,EAAI,CACf;AACAjB,QAAQ,CAACkB,EAAE,CAAC,QAAQ,CAAE,IAAM,CAC1BD,QAAQ,CAAC,CAAC,CACZ,CAAC,CAAC,CACF;AACA1B,KAAK,CAAC4B,IAAI,CAAC,IAAI,CAAC,CAClB,CACF,CAAC,CACH,CAAC,CAAAC,OAAA,CAAA/B,WAAA,CAAAA,WAAA","ignoreList":[]}