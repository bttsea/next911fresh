{"version":3,"names":["dropBundleIdentifier","exports","sprStatus","used","configKeys","Set","pageComponentVar","prerenderId","EXPORT_NAME_GET_STATIC_PROPS","EXPORT_NAME_GET_STATIC_PARAMS","replaceBundle","path","t","parentPath","replaceWith","program","variableDeclaration","variableDeclarator","identifier","assignmentExpression","stringLiteral","Date","now","nextPageConfig","types","visitor","Program","enter","state","traverse","ExportNamedDeclaration","bundleDropped","node","declaration","declarations","id","config","name","isPrerender","remove","init","type","pageName","filename","split","cwd","pop","Error","prop","properties","key","has","value","amp","ExportDefaultDeclaration","prev","cloneDeep","endsWith","replace","insertBefore","memberExpression","booleanLiteral"],"sources":["next-page-config.ts"],"sourcesContent":["import { PluginObj } from '@babel/core'\nimport { NodePath } from '@babel/traverse'\nimport * as BabelTypes from '@babel/types'\nimport { PageConfig } from '../../../types'\n\nexport const dropBundleIdentifier = '__NEXT_DROP_CLIENT_FILE__'\nexport const sprStatus = { used: false }\n\nconst configKeys = new Set(['amp'])\nconst pageComponentVar = '__NEXT_COMP'\n// this value can't be optimized by terser so the shorter the better\nconst prerenderId = '__NEXT_SPR'\nconst EXPORT_NAME_GET_STATIC_PROPS = 'unstable_getStaticProps'\nconst EXPORT_NAME_GET_STATIC_PARAMS = 'unstable_getStaticParams'\n\n// replace program path with just a variable with the drop identifier\nfunction replaceBundle(path: any, t: typeof BabelTypes) {\n  path.parentPath.replaceWith(\n    t.program(\n      [\n        t.variableDeclaration('const', [\n          t.variableDeclarator(\n            t.identifier('config'),\n            t.assignmentExpression(\n              '=',\n              t.identifier(dropBundleIdentifier),\n              t.stringLiteral(`${dropBundleIdentifier} ${Date.now()}`)\n            )\n          ),\n        ]),\n      ],\n      []\n    )\n  )\n}\n\ninterface ConfigState {\n  isPrerender?: boolean\n  bundleDropped?: boolean\n}\n\n// config to parsing pageConfig for client bundles\nexport default function nextPageConfig({\n  types: t,\n}: {\n  types: typeof BabelTypes\n}): PluginObj {\n  return {\n    visitor: {\n      Program: {\n        enter(path, state: ConfigState) {\n          path.traverse(\n            {\n              ExportNamedDeclaration(\n                path: NodePath<BabelTypes.ExportNamedDeclaration>,\n                state: any\n              ) {\n                if (state.bundleDropped || !path.node.declaration) {\n                  return\n                }\n                const { declarations, id } = path.node.declaration as any\n                const config: PageConfig = {}\n\n                // drop SSR Exports for client bundles\n                if (\n                  id &&\n                  (id.name === EXPORT_NAME_GET_STATIC_PROPS ||\n                    id.name === EXPORT_NAME_GET_STATIC_PARAMS)\n                ) {\n                  if (id.name === EXPORT_NAME_GET_STATIC_PROPS) {\n                    state.isPrerender = true\n                    sprStatus.used = true\n                  }\n                  path.remove()\n                  return\n                }\n\n                if (!declarations) {\n                  return\n                }\n                for (const declaration of declarations) {\n                  if (declaration.id.name !== 'config') {\n                    continue\n                  }\n\n                  if (declaration.init.type !== 'ObjectExpression') {\n                    const pageName =\n                      (state.filename || '').split(state.cwd || '').pop() ||\n                      'unknown'\n\n                    throw new Error(\n                      `Invalid page config export found. Expected object but got ${\n                        declaration.init.type\n                      } in file ${pageName}. See: https://err.sh/zeit/next.js/invalid-page-config`\n                    )\n                  }\n\n                  for (const prop of declaration.init.properties) {\n                    const { name } = prop.key\n                    if (configKeys.has(name)) {\n                      // @ts-ignore\n                      config[name] = prop.value.value\n                    }\n                  }\n                }\n\n                if (config.amp === true) {\n                  replaceBundle(path, t)\n                  state.bundleDropped = true\n                  return\n                }\n              },\n            },\n            state\n          )\n        },\n      },\n      ExportDefaultDeclaration(path, state: ConfigState) {\n        if (!state.isPrerender) {\n          return\n        }\n        const prev = t.cloneDeep(path.node.declaration)\n\n        // workaround to allow assigning a ClassDeclaration to a variable\n        // babel throws error without\n        if (prev.type.endsWith('Declaration')) {\n          prev.type = prev.type.replace(/Declaration$/, 'Expression') as any\n        }\n\n        path.insertBefore([\n          t.variableDeclaration('const', [\n            t.variableDeclarator(t.identifier(pageComponentVar), prev as any),\n          ]),\n          t.assignmentExpression(\n            '=',\n            t.memberExpression(\n              t.identifier(pageComponentVar),\n              t.identifier(prerenderId)\n            ),\n            t.booleanLiteral(true)\n          ),\n        ])\n\n        path.node.declaration = t.identifier(pageComponentVar)\n      },\n    },\n  }\n}\n"],"mappings":"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","ignoreList":[]}