{"version":3,"names":["_chalk","_interopRequireDefault","require","_path","_querystring","_constants","_config","_log","e","__esModule","default","createPagesMapping","pagePaths","extensions","previousPages","pages","reduce","result","pagePath","page","replace","RegExp","join","pageKey","warn","chalk","cyan","PAGES_DIR_ALIAS","createEntrypoints","target","buildId","config","client","server","defaultServerlessOptions","absoluteAppPath","absoluteDocumentPath","absoluteErrorPath","distDir","DOT_NEXT_ALIAS","assetPrefix","generateEtags","ampBindInitData","experimental","canonicalBase","Object","keys","forEach","absolutePagePath","bundleFile","isApiRoute","match","API_ROUTE","bundlePath","isLikeServerless","isTargetLikeServerless","serverlessLoaderOptions","stringify"],"sources":["entries.ts"],"sourcesContent":["import chalk from 'chalk'\nimport { join } from 'path'\nimport { stringify } from 'querystring'\n\nimport { API_ROUTE, DOT_NEXT_ALIAS, PAGES_DIR_ALIAS } from '../lib/constants'\nimport { isTargetLikeServerless } from '../next-server/server/config'\nimport { warn } from './output/log'\nimport { ServerlessLoaderQuery } from './webpack/loaders/next-serverless-loader'\n\ntype PagesMapping = {\n  [page: string]: string\n}\n\nexport function createPagesMapping(\n  pagePaths: string[],\n  extensions: string[]\n): PagesMapping {\n  const previousPages: PagesMapping = {}\n  const pages: PagesMapping = pagePaths.reduce(\n    (result: PagesMapping, pagePath): PagesMapping => {\n      let page = `${pagePath\n        .replace(new RegExp(`\\\\.+(${extensions.join('|')})$`), '')\n        .replace(/\\\\/g, '/')}`.replace(/\\/index$/, '')\n      page = page === '/index' ? '/' : page\n\n      const pageKey = page === '' ? '/' : page\n\n      if (pageKey in result) {\n        warn(\n          `Duplicate page detected. ${chalk.cyan(\n            join('pages', previousPages[pageKey])\n          )} and ${chalk.cyan(\n            join('pages', pagePath)\n          )} both resolve to ${chalk.cyan(pageKey)}.`\n        )\n      } else {\n        previousPages[pageKey] = pagePath\n      }\n      result[pageKey] = join(PAGES_DIR_ALIAS, pagePath).replace(/\\\\/g, '/')\n      return result\n    },\n    {}\n  )\n\n  pages['/_app'] = pages['/_app'] || 'next/dist/pages/_app'\n  pages['/_error'] = pages['/_error'] || 'next/dist/pages/_error'\n  pages['/_document'] = pages['/_document'] || 'next/dist/pages/_document'\n\n  return pages\n}\n\nexport type WebpackEntrypoints = {\n  [bundle: string]: string | string[]\n}\n\ntype Entrypoints = {\n  client: WebpackEntrypoints\n  server: WebpackEntrypoints\n}\n\nexport function createEntrypoints(\n  pages: PagesMapping,\n  target: 'server' | 'serverless' | 'experimental-serverless-trace',\n  buildId: string,\n  config: any\n): Entrypoints {\n  const client: WebpackEntrypoints = {}\n  const server: WebpackEntrypoints = {}\n\n  const defaultServerlessOptions = {\n    absoluteAppPath: pages['/_app'],\n    absoluteDocumentPath: pages['/_document'],\n    absoluteErrorPath: pages['/_error'],\n    distDir: DOT_NEXT_ALIAS,\n    buildId,\n    assetPrefix: config.assetPrefix,\n    generateEtags: config.generateEtags,\n    ampBindInitData: config.experimental.ampBindInitData,\n    canonicalBase: config.canonicalBase,\n  }\n\n  Object.keys(pages).forEach(page => {\n    const absolutePagePath = pages[page]\n    const bundleFile = page === '/' ? '/index.js' : `${page}.js`\n    const isApiRoute = page.match(API_ROUTE)\n\n    const bundlePath = join('static', buildId, 'pages', bundleFile)\n\n    const isLikeServerless = isTargetLikeServerless(target)\n\n    if (isApiRoute && isLikeServerless) {\n      const serverlessLoaderOptions: ServerlessLoaderQuery = {\n        page,\n        absolutePagePath,\n        ...defaultServerlessOptions,\n      }\n      server[join('pages', bundleFile)] = `next-serverless-loader?${stringify(\n        serverlessLoaderOptions\n      )}!`\n    } else if (isApiRoute || target === 'server') {\n      server[bundlePath] = [absolutePagePath]\n    } else if (isLikeServerless && page !== '/_app' && page !== '/_document') {\n      const serverlessLoaderOptions: ServerlessLoaderQuery = {\n        page,\n        absolutePagePath,\n        ...defaultServerlessOptions,\n      }\n      server[join('pages', bundleFile)] = `next-serverless-loader?${stringify(\n        serverlessLoaderOptions\n      )}!`\n    }\n\n    if (page === '/_document') {\n      return\n    }\n\n    if (!isApiRoute) {\n      client[bundlePath] = `next-client-pages-loader?${stringify({\n        page,\n        absolutePagePath,\n      })}!`\n    }\n  })\n\n  return {\n    client,\n    server,\n  }\n}\n"],"mappings":"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","ignoreList":[]}