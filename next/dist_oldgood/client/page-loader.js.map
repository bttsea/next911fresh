{"version":3,"names":["_mitt","_interopRequireDefault","require","e","__esModule","default","supportsPreload","el","relList","supports","hasPreload","document","createElement","preloadScript","url","link","rel","crossOrigin","process","href","encodeURI","as","head","appendChild","PageLoader","constructor","buildId","assetPrefix","pageCache","pageRegisterEvents","mitt","loadingRoutes","env","__NEXT_GRANULAR_CHUNKS","promisedBuildManifest","Promise","resolve","window","__BUILD_MANIFEST","__BUILD_MANIFEST_CB","getDependencies","route","then","man","map","normalizeRoute","Error","replace","loadPage","loadPageScript","v","page","reject","fire","error","mod","off","cachedPage","on","querySelector","deps","forEach","d","loadScript","loadRoute","scriptRoute","encodeURIComponent","isPage","script","__NEXT_MODERN_BUILD","type","src","onerror","code","emit","body","registerPage","regFn","register","pageData","NODE_ENV","module","hot","status","console","log","check","removeStatusHandler","prefetch","isDependency","cn","navigator","connection","effectiveType","indexOf","saveData","readyState","catch","addEventListener","exports"],"sources":["page-loader.js"],"sourcesContent":["/* global document, window */\nimport mitt from '../next-server/lib/mitt'\n\nfunction supportsPreload (el) {\n  try {\n    return el.relList.supports('preload')\n  } catch {\n    return false\n  }\n}\n\nconst hasPreload = supportsPreload(document.createElement('link'))\n\nfunction preloadScript (url) {\n  const link = document.createElement('link')\n  link.rel = 'preload'\n  link.crossOrigin = process.crossOrigin\n  link.href = encodeURI(url)\n  link.as = 'script'\n  document.head.appendChild(link)\n}\n\nexport default class PageLoader {\n  constructor (buildId, assetPrefix) {\n    this.buildId = buildId\n    this.assetPrefix = assetPrefix\n\n    this.pageCache = {}\n    this.pageRegisterEvents = mitt()\n    this.loadingRoutes = {}\n    if (process.env.__NEXT_GRANULAR_CHUNKS) {\n      this.promisedBuildManifest = new Promise(resolve => {\n        if (window.__BUILD_MANIFEST) {\n          resolve(window.__BUILD_MANIFEST)\n        } else {\n          window.__BUILD_MANIFEST_CB = () => {\n            resolve(window.__BUILD_MANIFEST)\n          }\n        }\n      })\n    }\n  }\n\n  // Returns a promise for the dependencies for a particular route\n  getDependencies (route) {\n    return this.promisedBuildManifest.then(\n      man => (man[route] && man[route].map(url => `/_next/${url}`)) || []\n    )\n  }\n\n  normalizeRoute (route) {\n    if (route[0] !== '/') {\n      throw new Error(`Route name should start with a \"/\", got \"${route}\"`)\n    }\n    route = route.replace(/\\/index$/, '/')\n\n    if (route === '/') return route\n    return route.replace(/\\/$/, '')\n  }\n\n  loadPage (route) {\n    return this.loadPageScript(route).then(v => v.page)\n  }\n\n  loadPageScript (route) {\n    route = this.normalizeRoute(route)\n\n    return new Promise((resolve, reject) => {\n      const fire = ({ error, page, mod }) => {\n        this.pageRegisterEvents.off(route, fire)\n        delete this.loadingRoutes[route]\n\n        if (error) {\n          reject(error)\n        } else {\n          resolve({ page, mod })\n        }\n      }\n\n      // If there's a cached version of the page, let's use it.\n      const cachedPage = this.pageCache[route]\n      if (cachedPage) {\n        const { error, page, mod } = cachedPage\n        error ? reject(error) : resolve({ page, mod })\n        return\n      }\n\n      // Register a listener to get the page\n      this.pageRegisterEvents.on(route, fire)\n\n      // If the page is loading via SSR, we need to wait for it\n      // rather downloading it again.\n      if (document.querySelector(`script[data-next-page=\"${route}\"]`)) {\n        return\n      }\n\n      if (!this.loadingRoutes[route]) {\n        if (process.env.__NEXT_GRANULAR_CHUNKS) {\n          this.getDependencies(route).then(deps => {\n            deps.forEach(d => {\n              if (!document.querySelector(`script[src^=\"${d}\"]`)) {\n                this.loadScript(d, route, false)\n              }\n            })\n            this.loadRoute(route)\n            this.loadingRoutes[route] = true\n          })\n        } else {\n          this.loadRoute(route)\n          this.loadingRoutes[route] = true\n        }\n      }\n    })\n  }\n\n  async loadRoute (route) {\n    route = this.normalizeRoute(route)\n    let scriptRoute = route === '/' ? '/index.js' : `${route}.js`\n\n    const url = `${this.assetPrefix}/_next/static/${encodeURIComponent(\n      this.buildId\n    )}/pages${scriptRoute}`\n    this.loadScript(url, route, true)\n  }\n\n  loadScript (url, route, isPage) {\n    const script = document.createElement('script')\n    if (process.env.__NEXT_MODERN_BUILD && 'noModule' in script) {\n      script.type = 'module'\n      // Only page bundle scripts need to have .module added to url,\n      // dependencies already have it added during build manifest creation\n      if (isPage) url = url.replace(/\\.js$/, '.module.js')\n    }\n    script.crossOrigin = process.crossOrigin\n    script.src = encodeURI(url)\n    script.onerror = () => {\n      const error = new Error(`Error loading script ${url}`)\n      error.code = 'PAGE_LOAD_ERROR'\n      this.pageRegisterEvents.emit(route, { error })\n    }\n    document.body.appendChild(script)\n  }\n\n  // This method if called by the route code.\n  registerPage (route, regFn) {\n    const register = () => {\n      try {\n        const mod = regFn()\n        const pageData = { page: mod.default || mod, mod }\n        this.pageCache[route] = pageData\n        this.pageRegisterEvents.emit(route, pageData)\n      } catch (error) {\n        this.pageCache[route] = { error }\n        this.pageRegisterEvents.emit(route, { error })\n      }\n    }\n\n    if (process.env.NODE_ENV !== 'production') {\n      // Wait for webpack to become idle if it's not.\n      // More info: https://github.com/zeit/next.js/pull/1511\n      if (module.hot && module.hot.status() !== 'idle') {\n        console.log(\n          `Waiting for webpack to become \"idle\" to initialize the page: \"${route}\"`\n        )\n\n        const check = status => {\n          if (status === 'idle') {\n            module.hot.removeStatusHandler(check)\n            register()\n          }\n        }\n        module.hot.status(check)\n        return\n      }\n    }\n\n    register()\n  }\n\n  async prefetch (route, isDependency) {\n    route = this.normalizeRoute(route)\n    let scriptRoute = `${route === '/' ? '/index' : route}.js`\n\n    if (\n      process.env.__NEXT_MODERN_BUILD &&\n      'noModule' in document.createElement('script')\n    ) {\n      scriptRoute = scriptRoute.replace(/\\.js$/, '.module.js')\n    }\n    const url = isDependency\n      ? route\n      : `${this.assetPrefix}/_next/static/${encodeURIComponent(\n        this.buildId\n      )}/pages${scriptRoute}`\n\n    // n.b. If preload is not supported, we fall back to `loadPage` which has\n    // its own deduping mechanism.\n    if (\n      document.querySelector(\n        `link[rel=\"preload\"][href^=\"${url}\"], script[data-next-page=\"${route}\"]`\n      )\n    ) {\n      return\n    }\n\n    // Inspired by quicklink, license: https://github.com/GoogleChromeLabs/quicklink/blob/master/LICENSE\n    let cn\n    if ((cn = navigator.connection)) {\n      // Don't prefetch if the user is on 2G or if Save-Data is enabled.\n      if ((cn.effectiveType || '').indexOf('2g') !== -1 || cn.saveData) {\n        return\n      }\n    }\n\n    if (process.env.__NEXT_GRANULAR_CHUNKS && !isDependency) {\n      ;(await this.getDependencies(route)).forEach(url => {\n        this.prefetch(url, true)\n      })\n    }\n\n    // Feature detection is used to see if preload is supported\n    // If not fall back to loading script tags before the page is loaded\n    // https://caniuse.com/#feat=link-rel-preload\n    if (hasPreload) {\n      preloadScript(url)\n      return\n    }\n\n    if (isDependency) {\n      // loadPage will automatically handle depencies, so no need to\n      // preload them manually\n      return\n    }\n\n    if (document.readyState === 'complete') {\n      return this.loadPage(route).catch(() => {})\n    } else {\n      return new Promise(resolve => {\n        window.addEventListener('load', () => {\n          this.loadPage(route).then(() => resolve(), () => resolve())\n        })\n      })\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}