{"version":3,"names":["_react","require","_dataManagerContext","_routerContext","_unfetch","_interopRequireDefault","_querystring","e","__esModule","default","generateArgsKey","args","reduce","a","b","Array","isArray","Error","toString","createHook","fetcher","options","key","useData","router","useContext","RouterContext","dataManager","DataManagerContext","existing","get","status","result","window","res","fetch","route","stringify","query","headers","accept","then","json","hasKey","some","pair","overwrite","set"],"sources":["data.ts"],"sourcesContent":["import { useContext } from 'react'\nimport { DataManagerContext } from '../next-server/lib/data-manager-context'\nimport { RouterContext } from '../next-server/lib/router-context'\nimport fetch from 'unfetch'\nimport { stringify } from 'querystring'\n\ntype Args = string | number | Array<string | number>\n\nfunction generateArgsKey(args: Args[]) {\n  return args.reduce((a: string, b: Args): string => {\n    if (Array.isArray(b)) {\n      return a + generateArgsKey(b)\n    }\n    if (typeof b !== 'string' && typeof b !== 'number') {\n      throw new Error('arguments can only be string or number')\n    }\n    return a + b.toString()\n  }, '')\n}\n\nexport function createHook(\n  fetcher: (...args: Args[]) => Promise<any>,\n  options: { key: string }\n) {\n  if (!options.key) {\n    throw new Error('key not provided to createHook options.')\n  }\n  return function useData(...args: Array<string | number>) {\n    const router: import('../next-server/lib/router/router').NextRouter = useContext(\n      RouterContext\n    )\n    const dataManager: import('../next-server/lib/data-manager').DataManager = useContext(\n      DataManagerContext\n    )\n    const key = `${options.key}${generateArgsKey(args)}`\n    const existing = dataManager.get(key)\n\n    if (existing) {\n      if (existing.status === 'resolved') {\n        return existing.result\n      }\n      if (existing === 'mismatched-key') {\n        throw new Error(\n          'matching key was missing from returned data. make sure arguments match between the client and server'\n        )\n      }\n    }\n\n    // @ts-ignore webpack optimization\n    if (typeof window !== 'undefined') {\n      const res = fetch(router.route + '?' + stringify(router.query), {\n        headers: {\n          accept: 'application/amp.bind+json',\n        },\n      })\n        .then((res: any) => res.json())\n        .then((result: any) => {\n          const hasKey = result.some((pair: [string, any]) => pair[0] === key)\n          if (!hasKey) {\n            result = [[key, 'mismatched-key']]\n          }\n          dataManager.overwrite(result)\n        })\n      throw res\n    } else {\n      const res = fetcher(...args).then(result => {\n        dataManager.set(key, {\n          status: 'resolved',\n          result,\n        })\n      })\n      throw res\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}