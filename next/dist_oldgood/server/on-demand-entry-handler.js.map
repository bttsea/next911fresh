{"version":3,"names":["_events","require","_path","_querystring","_url","_DynamicEntryPlugin","_interopRequireDefault","_isWriteable","Log","_interopRequireWildcard","_constants","_constants2","_normalizePagePath","_require","_findPageFile","e","t","WeakMap","r","n","__esModule","o","i","f","__proto__","default","has","get","set","hasOwnProperty","call","Object","defineProperty","getOwnPropertyDescriptor","ADDED","Symbol","BUILDING","BUILT","addEntry","compilation","context","name","entry","Promise","resolve","reject","dep","DynamicEntryPlugin","createDependency","err","onDemandEntryHandler","devMiddleware","multiCompiler","buildId","pagesDir","reload","pageExtensions","maxInactiveAge","pagesBufferLength","compilers","invalidator","Invalidator","entries","lastAccessPages","doneCallbacks","EventEmitter","reloading","stopped","reloadCallbacks","lastEntry","compiler","hooks","make","tapPromise","startBuilding","allEntries","keys","map","page","match","API_ROUTE","absolutePagePath","pageExists","isWriteable","event","status","stringify","all","catch","console","error","findHardFailedPages","errors","filter","hasNoModuleFoundError","test","message","IS_BUNDLED_PAGE_REGEX","module","dependencies","length","chunks","reduce","a","b","c","pageName","ROUTE_NAME_REGEX","exec","normalizePage","getPagePathsFromEntrypoints","entrypoints","pagePaths","entrypoint","result","pagePath","push","done","tap","multiStats","clientStats","serverStats","stats","hardFailedPages","Set","lastActiveTime","Date","now","emit","doneBuilding","log","join","then","stop","stack","process","exit","disposeHandler","setInterval","disposeInactiveEntries","unref","clearInterval","handlePing","pg","entryInfo","toSend","invalid","success","includes","unshift","pop","waitUntilReloaded","once","ensurePage","normalizedPagePath","normalizePagePath","pageNotFoundError","findPageFile","pageUrl","replace","RegExp","bundleFile","startsWith","posix","normalize","normalizedPage","handleCallback","invalidate","middleware","req","res","next","statusCode","setHeader","url","end","query","parse","runPing","data","write","JSON","pingInterval","on","setImmediate","disposingPages","forEach","unixPagePath","constructor","building","rebuildAgain"],"sources":["on-demand-entry-handler.ts"],"sourcesContent":["import { EventEmitter } from 'events'\nimport { IncomingMessage, ServerResponse } from 'http'\nimport { join, posix } from 'path'\nimport { stringify } from 'querystring'\nimport { parse } from 'url'\nimport webpack from 'webpack'\nimport WebpackDevMiddleware from 'webpack-dev-middleware'\nimport DynamicEntryPlugin from 'webpack/lib/DynamicEntryPlugin'\n\nimport { isWriteable } from '../build/is-writeable'\nimport * as Log from '../build/output/log'\nimport { API_ROUTE } from '../lib/constants'\nimport {\n  IS_BUNDLED_PAGE_REGEX,\n  ROUTE_NAME_REGEX,\n} from '../next-server/lib/constants'\nimport { normalizePagePath } from '../next-server/server/normalize-page-path'\nimport { pageNotFoundError } from '../next-server/server/require'\nimport { findPageFile } from './lib/find-page-file'\n\nconst ADDED = Symbol('added')\nconst BUILDING = Symbol('building')\nconst BUILT = Symbol('built')\n\n// Based on https://github.com/webpack/webpack/blob/master/lib/DynamicEntryPlugin.js#L29-L37\nfunction addEntry(\n  compilation: webpack.compilation.Compilation,\n  context: string,\n  name: string,\n  entry: string[]\n) {\n  return new Promise((resolve, reject) => {\n    const dep = DynamicEntryPlugin.createDependency(entry, name)\n    compilation.addEntry(context, dep, name, (err: Error) => {\n      if (err) return reject(err)\n      resolve()\n    })\n  })\n}\n\nexport default function onDemandEntryHandler(\n  devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n  multiCompiler: webpack.MultiCompiler,\n  {\n    buildId,\n    pagesDir,\n    reload,\n    pageExtensions,\n    maxInactiveAge,\n    pagesBufferLength,\n  }: {\n    buildId: string\n    pagesDir: string\n    reload: any\n    pageExtensions: string[]\n    maxInactiveAge: number\n    pagesBufferLength: number\n  }\n) {\n  const { compilers } = multiCompiler\n  const invalidator = new Invalidator(devMiddleware, multiCompiler)\n  let entries: any = {}\n  let lastAccessPages = ['']\n  let doneCallbacks: EventEmitter | null = new EventEmitter()\n  let reloading = false\n  let stopped = false\n  let reloadCallbacks: EventEmitter | null = new EventEmitter()\n  let lastEntry: string | null = null\n\n  for (const compiler of compilers) {\n    compiler.hooks.make.tapPromise(\n      'NextJsOnDemandEntries',\n      (compilation: webpack.compilation.Compilation) => {\n        invalidator.startBuilding()\n\n        const allEntries = Object.keys(entries).map(async page => {\n          if (compiler.name === 'client' && page.match(API_ROUTE)) {\n            return\n          }\n          const { name, absolutePagePath } = entries[page]\n          const pageExists = await isWriteable(absolutePagePath)\n          if (!pageExists) {\n            Log.event('page was removed', page)\n            delete entries[page]\n            return\n          }\n\n          entries[page].status = BUILDING\n          return addEntry(compilation, compiler.context, name, [\n            compiler.name === 'client'\n              ? `next-client-pages-loader?${stringify({\n                  page,\n                  absolutePagePath,\n                })}!`\n              : absolutePagePath,\n          ])\n        })\n\n        return Promise.all(allEntries).catch(err => console.error(err))\n      }\n    )\n  }\n\n  function findHardFailedPages(errors: any[]) {\n    return errors\n      .filter(e => {\n        // Make sure to only pick errors which marked with missing modules\n        const hasNoModuleFoundError =\n          /ENOENT/.test(e.message) || /Module not found/.test(e.message)\n        if (!hasNoModuleFoundError) return false\n\n        // The page itself is missing. So this is a failed page.\n        if (IS_BUNDLED_PAGE_REGEX.test(e.module.name)) return true\n\n        // No dependencies means this is a top level page.\n        // So this is a failed page.\n        return e.module.dependencies.length === 0\n      })\n      .map(e => e.module.chunks)\n      .reduce((a, b) => [...a, ...b], [])\n      .map((c: any) => {\n        const pageName = ROUTE_NAME_REGEX.exec(c.name)![1]\n        return normalizePage(`/${pageName}`)\n      })\n  }\n\n  function getPagePathsFromEntrypoints(entrypoints: any) {\n    const pagePaths = []\n    for (const [, entrypoint] of entrypoints.entries()) {\n      const result = ROUTE_NAME_REGEX.exec(entrypoint.name)\n      if (!result) {\n        continue\n      }\n\n      const pagePath = result[1]\n\n      if (!pagePath) {\n        continue\n      }\n\n      pagePaths.push(pagePath)\n    }\n\n    return pagePaths\n  }\n\n  multiCompiler.hooks.done.tap('NextJsOnDemandEntries', multiStats => {\n    const [clientStats, serverStats] = multiStats.stats\n    const hardFailedPages = [\n      ...new Set([\n        ...findHardFailedPages(clientStats.compilation.errors),\n        ...findHardFailedPages(serverStats.compilation.errors),\n      ]),\n    ]\n    const pagePaths = new Set([\n      ...getPagePathsFromEntrypoints(clientStats.compilation.entrypoints),\n      ...getPagePathsFromEntrypoints(serverStats.compilation.entrypoints),\n    ])\n\n    // compilation.entrypoints is a Map object, so iterating over it 0 is the key and 1 is the value\n    for (const pagePath of pagePaths) {\n      const page = normalizePage('/' + pagePath)\n\n      const entry = entries[page]\n      if (!entry) {\n        continue\n      }\n\n      if (entry.status !== BUILDING) {\n        continue\n      }\n\n      entry.status = BUILT\n      entry.lastActiveTime = Date.now()\n      doneCallbacks!.emit(page)\n    }\n\n    invalidator.doneBuilding()\n\n    if (hardFailedPages.length > 0 && !reloading) {\n      console.log(\n        `> Reloading webpack due to inconsistant state of pages(s): ${hardFailedPages.join(\n          ', '\n        )}`\n      )\n      reloading = true\n      reload()\n        .then(() => {\n          console.log('> Webpack reloaded.')\n          reloadCallbacks!.emit('done')\n          stop()\n        })\n        .catch((err: Error) => {\n          console.error(`> Webpack reloading failed: ${err.message}`)\n          console.error(err.stack)\n          process.exit(1)\n        })\n    }\n  })\n\n  const disposeHandler = setInterval(function() {\n    if (stopped) return\n    disposeInactiveEntries(\n      devMiddleware,\n      entries,\n      lastAccessPages,\n      maxInactiveAge\n    )\n  }, 5000)\n\n  disposeHandler.unref()\n\n  function stop() {\n    clearInterval(disposeHandler)\n    stopped = true\n    doneCallbacks = null\n    reloadCallbacks = null\n  }\n\n  function handlePing(pg: string) {\n    const page = normalizePage(pg)\n    const entryInfo = entries[page]\n    let toSend\n\n    // If there's no entry, it may have been invalidated and needs to be re-built.\n    if (!entryInfo) {\n      if (page !== lastEntry) {\n        Log.event(`client pings, but there's no entry for page: ${page}`)\n      }\n      lastEntry = page\n      return { invalid: true }\n    }\n\n    // 404 is an on demand entry but when a new page is added we have to refresh the page\n    if (page === '/_error') {\n      toSend = { invalid: true }\n    } else {\n      toSend = { success: true }\n    }\n\n    // We don't need to maintain active state of anything other than BUILT entries\n    if (entryInfo.status !== BUILT) return\n\n    // If there's an entryInfo\n    if (!lastAccessPages.includes(page)) {\n      lastAccessPages.unshift(page)\n\n      // Maintain the buffer max length\n      if (lastAccessPages.length > pagesBufferLength) {\n        lastAccessPages.pop()\n      }\n    }\n    entryInfo.lastActiveTime = Date.now()\n    return toSend\n  }\n\n  return {\n    waitUntilReloaded() {\n      if (!reloading) return Promise.resolve(true)\n      return new Promise(resolve => {\n        reloadCallbacks!.once('done', function() {\n          resolve()\n        })\n      })\n    },\n\n    async ensurePage(page: string) {\n      await this.waitUntilReloaded()\n      let normalizedPagePath: string\n      try {\n        normalizedPagePath = normalizePagePath(page)\n      } catch (err) {\n        console.error(err)\n        throw pageNotFoundError(page)\n      }\n\n      let pagePath = await findPageFile(\n        pagesDir,\n        normalizedPagePath,\n        pageExtensions\n      )\n\n      // Default the /_error route to the Next.js provided default page\n      if (page === '/_error' && pagePath === null) {\n        pagePath = 'next/dist/pages/_error'\n      }\n\n      if (pagePath === null) {\n        throw pageNotFoundError(normalizedPagePath)\n      }\n\n      let pageUrl = `/${pagePath\n        .replace(new RegExp(`\\\\.+(?:${pageExtensions.join('|')})$`), '')\n        .replace(/\\\\/g, '/')}`.replace(/\\/index$/, '')\n      pageUrl = pageUrl === '' ? '/' : pageUrl\n      const bundleFile = pageUrl === '/' ? '/index.js' : `${pageUrl}.js`\n      const name = join('static', buildId, 'pages', bundleFile)\n      const absolutePagePath = pagePath.startsWith('next/dist/pages')\n        ? require.resolve(pagePath)\n        : join(pagesDir, pagePath)\n\n      page = posix.normalize(pageUrl)\n\n      return new Promise((resolve, reject) => {\n        // Makes sure the page that is being kept in on-demand-entries matches the webpack output\n        const normalizedPage = normalizePage(page)\n        const entryInfo = entries[normalizedPage]\n\n        if (entryInfo) {\n          if (entryInfo.status === BUILT) {\n            resolve()\n            return\n          }\n\n          if (entryInfo.status === BUILDING) {\n            doneCallbacks!.once(normalizedPage, handleCallback)\n            return\n          }\n        }\n\n        Log.event(`build page: ${normalizedPage}`)\n\n        entries[normalizedPage] = { name, absolutePagePath, status: ADDED }\n        doneCallbacks!.once(normalizedPage, handleCallback)\n\n        invalidator.invalidate()\n\n        function handleCallback(err: Error) {\n          if (err) return reject(err)\n          resolve()\n        }\n      })\n    },\n\n    middleware() {\n      return (req: IncomingMessage, res: ServerResponse, next: Function) => {\n        if (stopped) {\n          // If this handler is stopped, we need to reload the user's browser.\n          // So the user could connect to the actually running handler.\n          res.statusCode = 302\n          res.setHeader('Location', req.url!)\n          res.end('302')\n        } else if (reloading) {\n          // Webpack config is reloading. So, we need to wait until it's done and\n          // reload user's browser.\n          // So the user could connect to the new handler and webpack setup.\n          this.waitUntilReloaded().then(() => {\n            res.statusCode = 302\n            res.setHeader('Location', req.url!)\n            res.end('302')\n          })\n        } else {\n          if (!/^\\/_next\\/webpack-hmr/.test(req.url!)) return next()\n\n          const { query } = parse(req.url!, true)\n          const page = query.page\n          if (!page) return next()\n\n          const runPing = () => {\n            const data = handlePing(query.page as string)\n            if (!data) return\n            res.write('data: ' + JSON.stringify(data) + '\\n\\n')\n          }\n          const pingInterval = setInterval(() => runPing(), 5000)\n\n          req.on('close', () => {\n            clearInterval(pingInterval)\n          })\n          // Do initial ping right after EventSource is finished being set up\n          setImmediate(() => runPing())\n          next()\n        }\n      }\n    },\n  }\n}\n\nfunction disposeInactiveEntries(\n  devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n  entries: any,\n  lastAccessPages: any,\n  maxInactiveAge: number\n) {\n  const disposingPages: any = []\n\n  Object.keys(entries).forEach(page => {\n    const { lastActiveTime, status } = entries[page]\n\n    // This means this entry is currently building or just added\n    // We don't need to dispose those entries.\n    if (status !== BUILT) return\n\n    // We should not build the last accessed page even we didn't get any pings\n    // Sometimes, it's possible our XHR ping to wait before completing other requests.\n    // In that case, we should not dispose the current viewing page\n    if (lastAccessPages.includes(page)) return\n\n    if (Date.now() - lastActiveTime > maxInactiveAge) {\n      disposingPages.push(page)\n    }\n  })\n\n  if (disposingPages.length > 0) {\n    disposingPages.forEach((page: any) => {\n      delete entries[page]\n    })\n    Log.event(`disposing inactive page(s): ${disposingPages.join(', ')}`)\n    devMiddleware.invalidate()\n  }\n}\n\n// /index and / is the same. So, we need to identify both pages as the same.\n// This also applies to sub pages as well.\nexport function normalizePage(page: string) {\n  const unixPagePath = page.replace(/\\\\/g, '/')\n  if (unixPagePath === '/index' || unixPagePath === '/') {\n    return '/'\n  }\n  return unixPagePath.replace(/\\/index$/, '')\n}\n\n// Make sure only one invalidation happens at a time\n// Otherwise, webpack hash gets changed and it'll force the client to reload.\nclass Invalidator {\n  private multiCompiler: webpack.MultiCompiler\n  private devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware\n  private building: boolean\n  private rebuildAgain: boolean\n\n  constructor(\n    devMiddleware: WebpackDevMiddleware.WebpackDevMiddleware,\n    multiCompiler: webpack.MultiCompiler\n  ) {\n    this.multiCompiler = multiCompiler\n    this.devMiddleware = devMiddleware\n    // contains an array of types of compilers currently building\n    this.building = false\n    this.rebuildAgain = false\n  }\n\n  invalidate() {\n    // If there's a current build is processing, we won't abort it by invalidating.\n    // (If aborted, it'll cause a client side hard reload)\n    // But let it to invalidate just after the completion.\n    // So, it can re-build the queued pages at once.\n    if (this.building) {\n      this.rebuildAgain = true\n      return\n    }\n\n    this.building = true\n    // Work around a bug in webpack, calling `invalidate` on Watching.js\n    // doesn't trigger the invalid call used to keep track of the `.done` hook on multiCompiler\n    for (const compiler of this.multiCompiler.compilers) {\n      compiler.hooks.invalid.call()\n    }\n    this.devMiddleware.invalidate()\n  }\n\n  startBuilding() {\n    this.building = true\n  }\n\n  doneBuilding() {\n    this.building = false\n\n    if (this.rebuildAgain) {\n      this.rebuildAgain = false\n      this.invalidate()\n    }\n  }\n}\n"],"mappings":"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","ignoreList":[]}