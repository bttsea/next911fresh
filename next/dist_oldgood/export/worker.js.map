{"version":3,"names":["_mkdirp","_interopRequireDefault","require","_util","_path","_render","_fs","_amphtmlValidator","_loadComponents","_isDynamic","_routeMatcher","_routeRegex","e","__esModule","default","envConfig","writeFileP","promisify","writeFile","mkdirp","mkdirpModule","accessP","access","global","__NEXT_DATA__","nextExport","_default","path","pathMap","distDir","buildId","outDir","sprDataDir","renderOpts","buildExport","serverRuntimeConfig","subFolders","serverless","results","ampValidations","query","page","filePath","ampPath","isDynamicRoute","params","getRouteMatcher","getRouteRegex","Error","headerMocks","headers","getHeader","setHeader","hasHeader","removeHeader","getHeaderNames","req","url","res","setConfig","publicRuntimeConfig","runtimeConfig","htmlFilename","sep","pageExt","extname","pathExt","baseDir","join","dirname","htmlFilepath","html","curRenderOpts","renderMethod","renderToHTML","renderedDuringBuild","unstable_getStaticProps","mod","renderReqToHTML","result","components","loadComponents","Component","validateAmp","validator","AmpHtmlValidator","getInstance","validateString","errors","filter","severity","warnings","length","push","inAmpMode","hybridAmp","ampHtmlFilename","ampBaseDir","ampHtmlFilepath","_","ampHtml","includes","amp","sprData","dataFile","replace","JSON","stringify","fromBuildExportRevalidate","revalidate","error","console"],"sources":["worker.js"],"sourcesContent":["import mkdirpModule from 'mkdirp'\nimport { promisify } from 'util'\nimport { extname, join, dirname, sep } from 'path'\nimport { renderToHTML } from '../next-server/server/render'\nimport { writeFile, access } from 'fs'\nimport AmpHtmlValidator from 'amphtml-validator'\nimport { loadComponents } from '../next-server/server/load-components'\nimport { isDynamicRoute } from '../next-server/lib/router/utils/is-dynamic'\nimport { getRouteMatcher } from '../next-server/lib/router/utils/route-matcher'\nimport { getRouteRegex } from '../next-server/lib/router/utils/route-regex'\n\nconst envConfig = require('../next-server/lib/runtime-config')\nconst writeFileP = promisify(writeFile)\nconst mkdirp = promisify(mkdirpModule)\nconst accessP = promisify(access)\n\nglobal.__NEXT_DATA__ = {\n  nextExport: true\n}\n\nexport default async function ({\n  path,\n  pathMap,\n  distDir,\n  buildId,\n  outDir,\n  sprDataDir,\n  renderOpts,\n  buildExport,\n  serverRuntimeConfig,\n  subFolders,\n  serverless\n}) {\n  let results = {\n    ampValidations: []\n  }\n\n  try {\n    let { query = {} } = pathMap\n    const { page } = pathMap\n    const filePath = path === '/' ? '/index' : path\n    const ampPath = `${filePath}.amp`\n\n    // Check if the page is a specified dynamic route\n    if (isDynamicRoute(page) && page !== path) {\n      const params = getRouteMatcher(getRouteRegex(page))(path)\n      if (params) {\n        query = {\n          ...query,\n          ...params\n        }\n      } else {\n        throw new Error(\n          `The provided export path '${path}' doesn't match the '${page}' page.\\nRead more: https://err.sh/zeit/next.js/export-path-mismatch`\n        )\n      }\n    }\n\n    const headerMocks = {\n      headers: {},\n      getHeader: () => ({}),\n      setHeader: () => {},\n      hasHeader: () => false,\n      removeHeader: () => {},\n      getHeaderNames: () => []\n    }\n\n    const req = {\n      url: path,\n      ...headerMocks\n    }\n    const res = {\n      ...headerMocks\n    }\n\n    envConfig.setConfig({\n      serverRuntimeConfig,\n      publicRuntimeConfig: renderOpts.runtimeConfig\n    })\n\n    let htmlFilename = `${filePath}${sep}index.html`\n    if (!subFolders) htmlFilename = `${filePath}.html`\n\n    const pageExt = extname(page)\n    const pathExt = extname(path)\n    // Make sure page isn't a folder with a dot in the name e.g. `v1.2`\n    if (pageExt !== pathExt && pathExt !== '') {\n      // If the path has an extension, use that as the filename instead\n      htmlFilename = path\n    } else if (path === '/') {\n      // If the path is the root, just use index.html\n      htmlFilename = 'index.html'\n    }\n\n    const baseDir = join(outDir, dirname(htmlFilename))\n    const htmlFilepath = join(outDir, htmlFilename)\n\n    await mkdirp(baseDir)\n    let html\n    let curRenderOpts = {}\n    let renderMethod = renderToHTML\n\n    // eslint-disable-next-line camelcase\n    const renderedDuringBuild = unstable_getStaticProps => {\n      // eslint-disable-next-line camelcase\n      return !buildExport && unstable_getStaticProps && !isDynamicRoute(path)\n    }\n\n    if (serverless) {\n      const mod = require(join(\n        distDir,\n        'serverless/pages',\n        (page === '/' ? 'index' : page) + '.js'\n      ))\n\n      // for non-dynamic SPR pages we should have already\n      // prerendered the file\n      if (renderedDuringBuild(mod.unstable_getStaticProps)) return results\n\n      renderMethod = mod.renderReqToHTML\n      const result = await renderMethod(req, res, true)\n      curRenderOpts = result.renderOpts || {}\n      html = result.html\n\n      if (!html) {\n        throw new Error(`Failed to render serverless page`)\n      }\n    } else {\n      const components = await loadComponents(\n        distDir,\n        buildId,\n        page,\n        serverless\n      )\n\n      // for non-dynamic SPR pages we should have already\n      // prerendered the file\n      if (renderedDuringBuild(components.unstable_getStaticProps)) {\n        return results\n      }\n\n      if (typeof components.Component === 'string') {\n        html = components.Component\n      } else {\n        curRenderOpts = { ...components, ...renderOpts, ampPath }\n        html = await renderMethod(req, res, page, query, curRenderOpts)\n      }\n    }\n\n    const validateAmp = async (html, page) => {\n      const validator = await AmpHtmlValidator.getInstance()\n      const result = validator.validateString(html)\n      const errors = result.errors.filter(e => e.severity === 'ERROR')\n      const warnings = result.errors.filter(e => e.severity !== 'ERROR')\n\n      if (warnings.length || errors.length) {\n        results.ampValidations.push({\n          page,\n          result: {\n            errors,\n            warnings\n          }\n        })\n      }\n    }\n\n    if (curRenderOpts.inAmpMode) {\n      await validateAmp(html, path)\n    } else if (curRenderOpts.hybridAmp) {\n      // we need to render the AMP version\n      let ampHtmlFilename = `${ampPath}${sep}index.html`\n      if (!subFolders) {\n        ampHtmlFilename = `${ampPath}.html`\n      }\n      const ampBaseDir = join(outDir, dirname(ampHtmlFilename))\n      const ampHtmlFilepath = join(outDir, ampHtmlFilename)\n\n      try {\n        await accessP(ampHtmlFilepath)\n      } catch (_) {\n        // make sure it doesn't exist from manual mapping\n        let ampHtml\n        if (serverless) {\n          req.url += (req.url.includes('?') ? '&' : '?') + 'amp=1'\n          ampHtml = (await renderMethod(req, res, true)).html\n        } else {\n          ampHtml = await renderMethod(\n            req,\n            res,\n            page,\n            { ...query, amp: 1 },\n            curRenderOpts\n          )\n        }\n\n        await validateAmp(ampHtml, page + '?amp=1')\n        await mkdirp(ampBaseDir)\n        await writeFileP(ampHtmlFilepath, ampHtml, 'utf8')\n      }\n    }\n\n    if (curRenderOpts.sprData) {\n      const dataFile = join(\n        sprDataDir,\n        htmlFilename.replace(/\\.html$/, '.json')\n      )\n\n      await mkdirp(dirname(dataFile))\n      await writeFileP(dataFile, JSON.stringify(curRenderOpts.sprData), 'utf8')\n    }\n    results.fromBuildExportRevalidate = curRenderOpts.revalidate\n\n    await writeFileP(htmlFilepath, html, 'utf8')\n    return results\n  } catch (error) {\n    console.error(`\\nError occurred prerendering ${path}:`, error)\n    return { ...results, error: true }\n  }\n}\n"],"mappings":"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","ignoreList":[]}